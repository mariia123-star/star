# 📁 Файловое хранилище портала STAR

## 🎯 Обзор системы

Создана полноценная система управления файлами для портала STAR с поддержкой Supabase Storage, версионированием, системой тегов и расширенной аналитикой.

## 📋 Структура системы

### Основные компоненты:

1. **📊 Метаданные файлов** - полная информация о файлах в PostgreSQL
2. **☁️ Физическое хранение** - файлы в Supabase Storage 
3. **🏷️ Система тегов** - гибкая маркировка для поиска
4. **📈 Версионирование** - автоматическое отслеживание изменений
5. **📋 Коллекции** - группировка файлов в альбомы/папки
6. **🔗 Расшаренные ссылки** - безопасный публичный доступ
7. **📊 Аудит** - полное логирование всех операций

## 🗂️ Структура таблиц

### Основные таблицы:

- **`file_categories`** - категории файлов (документы, изображения, чертежи и т.д.)
- **`files`** - основная таблица с метаданными файлов
- **`file_versions`** - история версий файлов
- **`file_tags`** - теги для маркировки
- **`file_tags_mapping`** - связь файлов с тегами
- **`file_access_logs`** - логи всех операций с файлами
- **`file_collections`** - коллекции файлов
- **`file_collection_items`** - элементы коллекций
- **`file_share_links`** - расшаренные ссылки

## 🚀 Установка и настройка

### 1. Выполните миграцию базы данных

```bash
# В Supabase SQL Editor выполните:
```

**Основная миграция:** `FILE_STORAGE_MIGRATION.sql`
```sql
-- Создает все необходимые таблицы, индексы, триггеры и представления
-- Включает начальные данные (категории и теги)
-- Настраивает автоматические функции
```

**Настройка Storage:** `SUPABASE_STORAGE_SETUP.sql`  
```sql
-- Создает бакеты в Supabase Storage
-- Настраивает политики безопасности
-- Добавляет вспомогательные функции
```

### 2. Настройте переменные окружения

Добавьте в `.env`:
```env
# Supabase Storage
VITE_STORAGE_BUCKET=files
VITE_PUBLIC_STORAGE_BUCKET=public-files
VITE_TEMP_STORAGE_BUCKET=temp-uploads
VITE_ARCHIVE_STORAGE_BUCKET=archives

# Лимиты файлов  
VITE_MAX_FILE_SIZE=104857600
VITE_MAX_ARCHIVE_SIZE=1073741824
VITE_MAX_IMAGE_SIZE=10485760
```

## 💼 Возможности системы

### ✨ Ключевые функции:

1. **Загрузка файлов**
   - Поддержка различных типов файлов
   - Автоматическое определение MIME-типов
   - Проверка размера и расширений
   - Генерация SHA-256 хеша для целостности

2. **Категоризация**
   - Предустановленные категории: Документы, Таблицы, Изображения, Чертежи, Архивы, Сметы
   - Настраиваемые лимиты размера для каждой категории
   - Ограничения по типам файлов

3. **Система тегов**
   - Гибкое тегирование файлов
   - Цветовая маркировка тегов
   - Автоматические системные теги
   - Счетчик использования тегов

4. **Версионирование**
   - Автоматическое создание версий при изменении файлов
   - История изменений с описанием
   - Возможность отката к предыдущим версиям

5. **Права доступа**
   - Уровни доступа: public, internal, private, restricted
   - Привязка к пользователям и проектам
   - Временные ограничения доступа

6. **Расшаренные ссылки**
   - Генерация безопасных ссылок для внешнего доступа
   - Ограничение по времени и количеству скачиваний
   - Защита паролем
   - Детальная аналитика использования

7. **Коллекции файлов**
   - Группировка файлов в коллекции
   - Ручные и автоматические коллекции
   - Умные фильтры для автоматической группировки

8. **Полнотекстовый поиск**
   - Поиск по названиям файлов
   - Поиск по описаниям
   - Поддержка русского языка
   - Поиск по тегам

9. **Аналитика и мониторинг**
   - Статистика скачиваний и просмотров
   - Мониторинг использования Storage
   - Поиск дублирующихся файлов
   - Аудит всех операций

## 📊 Supabase Storage бакеты

### Созданные бакеты:

1. **`files`** (приватный) - основные файлы портала
   - Лимит: 100MB на файл
   - Типы: документы, таблицы, изображения

2. **`public-files`** (публичный) - публично доступные файлы  
   - Лимит: 10MB на файл
   - Типы: только изображения

3. **`archives`** (приватный) - архивы и большие файлы
   - Лимит: 1GB на файл  
   - Типы: zip, rar, 7z и другие архивы

4. **`temp-uploads`** (приватный) - временные загрузки
   - Лимит: 200MB на файл
   - Типы: любые (для обработки)

## 🔧 Автоматические функции

### Триггеры и автоматизация:

- **Версионирование** - автоматическое создание версий при изменении
- **Счетчики** - обновление статистики скачиваний и просмотров  
- **Теги** - обновление счетчика использования тегов
- **Коллекции** - автообновление статистики коллекций
- **Очистка** - удаление истекших ссылок и старых логов

### Полезные функции:

```sql
-- Генерация пути файла
SELECT public.generate_file_path(user_id, 'documents', 'contract.pdf');

-- Создание расшаренной ссылки  
SELECT public.create_share_link(file_id, 'Название', 24, 10, 'пароль');

-- Безопасное удаление файла
SELECT public.safe_delete_file(file_id);

-- Получение URL файла
SELECT public.get_file_url('files', 'path/to/file.pdf');
```

## 📈 Представления для аналитики

### Готовые представления:

- **`v_files_detailed`** - файлы с полной информацией (категории, теги, статистика)
- **`v_file_statistics`** - общая статистика системы
- **`v_popular_files`** - популярные файлы по количеству обращений
- **`v_storage_usage`** - использование Storage по бакетам
- **`v_duplicate_files`** - поиск дублирующихся файлов

## 🔗 Интеграция с порталом

### Связи с основными сущностями:

- **Проекты** - файлы привязываются к проектам через `project_id`
- **Тендерные сметы** - связь через `tender_estimate_id`
- **Расценки** - связь через `rate_id`
- **Материалы** - связь через `material_id`
- **Пользователи** - отслеживание загрузчика через `uploaded_by`

## 🛡️ Безопасность

### Меры безопасности:

- **RLS отключен** согласно требованиям проекта
- **Политики Storage** для контроля доступа к файлам
- **SHA-256 хеширование** для проверки целостности
- **Временные ссылки** с ограничениями доступа
- **Аудит операций** - полное логирование
- **Soft delete** - восстановимое удаление

## 📝 Примеры использования

### TypeScript API (примеры):

```typescript
// Загрузка файла
const uploadFile = async (file: File, categoryId: string) => {
  const { data, error } = await supabase.storage
    .from('files')
    .upload(`${userId}/${categoryId}/${filename}`, file)
}

// Создание записи в БД
const createFileRecord = async (fileData: FileCreate) => {
  const { data, error } = await supabase
    .from('files')
    .insert(fileData)
    .select()
}

// Получение файлов с деталями
const getFilesWithDetails = async () => {
  const { data, error } = await supabase
    .from('v_files_detailed')
    .select('*')
    .order('created_at', { ascending: false })
}
```

## 🎯 Готово к использованию

**✅ Система файлового хранилища полностью настроена и готова к интеграции в портал STAR!**

### Следующие шаги:

1. Выполните миграции SQL в Supabase
2. Настройте переменные окружения  
3. Создайте TypeScript API слои
4. Интегрируйте компоненты загрузки файлов в UI
5. Настройте мониторинг и аналитику

Система поддерживает все современные требования к файловому хранилищу и готова к масштабированию.