# Реализован полный функционал сохранения изменений в табличном режиме

## Что было сделано:

### 1. Кнопка сохранения изменений
✅ Кнопка "Сохранить как черновик" в табличном режиме TenderTest
✅ Кнопка меняет цвет на красный при наличии несохраненных изменений
✅ Отображает счетчик изменений в скобках
✅ Автоматически активируется при любых изменениях

### 2. База данных
✅ Создана таблица `estimate_drafts` для хранения черновиков
✅ Черновики сохраняются в формате JSONB
✅ Привязка к проектам через `project_id`
✅ Автоматическое обновление `updated_at`

### 3. Отслеживание изменений
✅ Каждое редактирование позиции помечается флагом `isEdited`
✅ Ведется подсчет измененных позиций
✅ При добавлении новых позиций они автоматически помечаются как измененные
✅ При импорте из сборника расценок позиции помечаются как измененные

### 4. Автосохранение
✅ Автоматическое сохранение через 5 секунд после последнего изменения
✅ Предотвращение потери данных при случайном закрытии

### 5. Загрузка черновиков
✅ Выпадающий список для выбора существующего черновика
✅ Черновики фильтруются по выбранному проекту
✅ При загрузке черновика все флаги изменений сбрасываются

## Как это работает:

### Для пользователя:
1. Выберите проект в выпадающем списке
2. Внесите изменения в табличный режим
3. Кнопка "Сохранить как черновик" станет красной
4. Нажмите кнопку или подождите 5 секунд для автосохранения
5. При необходимости загрузите существующий черновик

### Технические детали:

#### Отслеживание изменений в `TenderTest.tsx`:
```typescript
const handlePositionUpdate = (id: string, updates: Partial<EstimatePosition>) => {
  // Помечаем позицию как измененную
  return { ...position, ...updates, isEdited: true }

  // Добавляем в список измененных
  setModifiedPositions(prev => {
    const newSet = new Set(prev)
    newSet.add(id)
    return newSet
  })
}
```

#### Сохранение в базу данных:
```typescript
const handleSaveChanges = async () => {
  const draftData = {
    positions: positions,
    metadata: {
      positionsCount: positions.length,
      modifiedCount: modifiedPositions.size,
      lastModified: new Date().toISOString()
    }
  }

  // Сохраняем в таблицу estimate_drafts
  await supabase
    .from('estimate_drafts')
    .insert({
      project_id: selectedProject,
      name: draftName,
      data: draftData,
      total_amount: totalAmount,
      status: 'draft'
    })
}
```

## Файлы, которые были изменены:

1. **src/pages/documents/TenderTest.tsx**
   - Добавлено отслеживание изменений
   - Добавлена кнопка сохранения
   - Реализовано автосохранение
   - Добавлена загрузка черновиков

2. **src/widgets/estimate/EstimateTable.tsx**
   - Добавлен флаг `isEdited` при редактировании

3. **src/shared/types/estimate.ts**
   - Добавлено поле `isEdited?: boolean`

4. **supabase/estimate_drafts.sql**
   - Создана таблица для хранения черновиков

## Инструкция по применению базы данных:

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Выполните содержимое файла `supabase/estimate_drafts.sql`
4. Проверьте создание таблицы в Table Editor

## Статус: ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

Все изменения теперь:
- Отслеживаются в реальном времени
- Сохраняются в базу данных
- Автосохраняются через 5 секунд
- Могут быть загружены из черновиков

Кнопка сохранения активна и работает корректно!