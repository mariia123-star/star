# Журнал изменений - Новые функции

## 2025-10-10

### Добавлена автоматическая связь материалов с расценками

#### Что добавлено:

1. **Столбец `rate_category` в таблице `materials`**
   - Файл миграции: `supabase/add_rate_category_to_materials.sql`
   - Инструкция по применению: `APPLY_RATE_CATEGORY_MIGRATION.md`
   - Тип данных: `character varying(200)`
   - Индекс для оптимизации: `idx_materials_rate_category`

2. **Поле "Категория расценки" в форме создания/редактирования материалов**
   - Файл: `src/pages/developer/Materials.tsx`
   - Расположение: форма создания/редактирования материала
   - Описание: текстовое поле с подсказкой о автоматической связи

3. **Функция автоматического связывания материалов с расценками**
   - Файл: `src/pages/developer/Materials.tsx`
   - Функция: `handleRateCategoryLink()`
   - Как работает:
     - При создании/обновлении материала с заполненным полем `rate_category`
     - Система ищет все расценки, где `subcategory` совпадает с `rate_category` материала
     - Автоматически создаёт записи в таблице `rate_materials_mapping`
     - Отображает успешное сообщение с количеством связанных расценок

4. **Обновлённые TypeScript типы**
   - Файл: `src/entities/materials/types.ts`
   - Добавлено поле `rate_category?: string` в интерфейсы:
     - `Material`
     - `MaterialCreate`
     - `MaterialUpdate`

#### Как использовать:

1. **Примените миграцию БД** (см. `APPLY_RATE_CATEGORY_MIGRATION.md`)
2. **Создайте или отредактируйте материал**
3. **Заполните поле "Категория расценки"** (например: "кирпич", "вяжущие", "арматура")
4. **Сохраните материал**
5. Система автоматически найдёт все расценки с соответствующей подкатегорией и свяжет материал с ними

#### Пример:

```
Материал: Кирпич керамический
Категория расценки: кирпич

Результат:
- Найдены расценки: "Кладка кирпичная" (subcategory = "кирпич")
- Создана связь в rate_materials_mapping
- Материал доступен для использования в этих расценках
```

---

### Добавлен функционал экспорта/импорта расценок в Excel

#### Что добавлено:

1. **Кнопка "Экспорт в Excel" на странице "Сборник расценок"**
   - Файл: `src/pages/developer/Rates.tsx`
   - Функция: `handleExportRates()`
   - Формат экспорта:
     - Код
     - Наименование
     - Описание
     - Категория
     - Подкатегория
     - Единица измерения
     - Базовая цена
     - Активность
   - Имя файла: `Расценки_YYYY-MM-DD.xlsx`

2. **Кнопка "Импорт из Excel" на странице "Сборник расценок"**
   - Файл: `src/pages/developer/Rates.tsx`
   - Функция: `handleImportClick()`, `handleFileUpload()`, `handleImport()`
   - Поддерживаемые форматы: `.xlsx`, `.xls`
   - Максимальный размер файла: 10 MB
   - Валидация:
     - Проверка обязательных полей (код, наименование)
     - Автоматическое сопоставление единиц измерения
     - Обработка ошибок парсинга

3. **Модальное окно импорта**
   - Предпросмотр импортируемых данных в таблице
   - Валидация перед импортом
   - Отображение количества записей для импорта
   - Информация о формате данных

#### Как использовать:

**Экспорт расценок:**
1. Откройте страницу "Сборник расценок"
2. Нажмите кнопку "Экспорт в Excel"
3. Файл автоматически скачается в папку загрузок

**Импорт расценок:**
1. Откройте страницу "Сборник расценок"
2. Нажмите кнопку "Импорт из Excel"
3. Выберите файл Excel с расценками
4. Просмотрите данные в таблице предпросмотра
5. Нажмите "Импортировать (N)" для загрузки расценок

#### Формат Excel файла для импорта:

| Код | Наименование | Описание | Категория | Подкатегория | Единица измерения | Базовая цена | Активность |
|-----|--------------|----------|-----------|--------------|-------------------|--------------|------------|
| РЦ-001 | Кладка кирпичная | Кладка стен | Строительные работы | кирпич | м² | 1500 | Да |
| РЦ-002 | Штукатурка стен | Отделочные работы | Отделка | штукатурка | м² | 800 | Да |

---

## Технические детали

### Изменённые файлы:

1. **Миграции БД:**
   - `supabase/add_rate_category_to_materials.sql` - новая миграция

2. **Типы:**
   - `src/entities/materials/types.ts` - добавлено поле `rate_category`

3. **Страницы:**
   - `src/pages/developer/Materials.tsx` - автоматическая связь материалов с расценками
   - `src/pages/developer/Rates.tsx` - экспорт/импорт расценок в Excel

4. **Документация:**
   - `APPLY_RATE_CATEGORY_MIGRATION.md` - инструкция по применению миграции
   - `CHANGELOG_FEATURES.md` - этот файл

### Зависимости:

- `xlsx` - уже установлен
- Все необходимые зависимости Ant Design уже подключены

### Логирование:

Все пользовательские действия логируются в консоль:
- Создание/обновление материалов с категорией расценки
- Экспорт расценок в Excel
- Импорт расценок из Excel
- Связывание материалов с расценками

---

## Проверка

### Проверка типов TypeScript:
```bash
npm run type-check
```
✅ Проверка пройдена успешно

### Проверка линтером:
```bash
npm run lint
```
✅ Все новые изменения соответствуют стандартам

---

## Следующие шаги

1. ✅ Применить миграцию `supabase/add_rate_category_to_materials.sql` в БД
2. ✅ Протестировать автоматическую связь материалов с расценками
3. ✅ Протестировать экспорт расценок в Excel
4. ✅ Протестировать импорт расценок из Excel
5. Создать коммит с изменениями
6. Запушить изменения в GitHub

---

## Примечания

- Автоматическая связь материалов работает только при совпадении `rate_category` материала и `subcategory` расценки (без учёта регистра)
- Экспорт включает все расценки из системы
- Импорт автоматически сопоставляет единицы измерения по имени или короткому имени
- Все операции логируются для отладки и аудита
