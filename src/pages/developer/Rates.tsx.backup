import React, { useState, useEffect } from 'react'
import {
  Button,
  Space,
  Typography,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  message,
  Tag,
  Row,
  Col,
  Card,
  InputNumber,
  Tabs,
  List,
  Statistic,
  App,
  Popconfirm,
  DatePicker,
} from 'antd'
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  SearchOutlined,
  BuildOutlined,
  CalculatorOutlined,
  FileTextOutlined,
  DownloadOutlined,
  ExportOutlined,
  RightOutlined,
  DownOutlined,
} from '@ant-design/icons'
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { ratesApi, RateUpdate, RateWithUnit, rateMaterialsApi, RateMaterial } from '@/entities/rates'
import { unitsApi, Unit } from '@/entities/units'
import { materialsApi, MaterialWithUnit } from '@/entities/materials'
import { supabase } from '@/lib/supabase'
import { RateGroup, RatePosition, RATE_COLORS } from '@/shared/types/estimate'
import AddRateModal from '@/widgets/estimate/AddRateModal'
import { usePortalLogger } from '@/shared/hooks/usePortalLogger'
import { generateRateCode } from '@/shared/utils/codeGenerator'

const { Title, Text } = Typography
const { Search } = Input


interface RateFormData {
  code: string
  name: string
  description?: string
  unit_id: string
  base_price: number
  category: string
  subcategory?: string
  is_active: boolean
}

interface MaterialFormData {
  code: string
  name: string
  description?: string
  category: string
  unit_id: string
  last_purchase_price?: number
  supplier?: string
  supplier_article?: string
  is_active: boolean
}


// –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Ü–µ–Ω–æ–∫ –∏–∑ –ë–î –≤ —Ñ–æ—Ä–º–∞—Ç RateGroup
const convertRatesToGroups = (
  rates: RateWithUnit[],
  allRateMaterials: Record<string, RateMaterial[]>
): RateGroup[] => {
  return rates.map(rate => {
    const rateId = rate.id

    // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑—á–∏–∫–∞ (–æ—Å–Ω–æ–≤–Ω—É—é –ø–æ–∑–∏—Ü–∏—é)
    const contractor: RatePosition = {
      id: `contractor-${rateId}`,
      type: '–ó–∞–∫–∞–∑—á–∏–∫',
      name: rate.name,
      unit: rate.unit_short_name || '–µ–¥',
      volume: 1,
      consumptionRate: 1,
      workPrice: rate.base_price,
      materialPrice: 0,
      deliveryPrice: 0,
      total: rate.base_price,
      groupId: rateId
    }

    // –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—Ç—ã (–æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é —Ä–∞–±–æ—Ç)
    const work: RatePosition = {
      id: `work-${rateId}`,
      type: '—Ä–∞–±',
      name: rate.name,
      unit: rate.unit_short_name || '–µ–¥',
      volume: 1,
      consumptionRate: 1,
      workPrice: rate.base_price,
      materialPrice: 0,
      deliveryPrice: 0,
      total: rate.base_price,
      groupId: rateId
    }

    // –°–æ–∑–¥–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
    const rateMaterials = allRateMaterials[rateId] || []
    const materials: RatePosition[] = rateMaterials.map((rateMaterial, index) => {
      const volume = rateMaterial.consumption || 1
      const consumptionRate = rateMaterial.consumption || 1
      const materialPrice = rateMaterial.unit_price || 0
      const deliveryPrice = 0 // TODO: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –ë–î

      // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: –æ–±—ä–µ–º * —Ä–∞—Å—Ö–æ–¥ * —Å—Ç–æ–∏–º–æ—Å—Ç—å + –¥–æ—Å—Ç–∞–≤–∫–∞
      const materialTotal = volume * consumptionRate * materialPrice + deliveryPrice

      return {
        id: `material-${rateId}-${index}`,
        type: '–º–∞—Ç',
        materialType: rateMaterial.material?.category === 'material' ? '–û—Å–Ω–æ–≤–Ω–æ–π' : '–í—Å–ø–æ–º',
        name: rateMaterial.material?.name || '–ú–∞—Ç–µ—Ä–∏–∞–ª',
        unit: rateMaterial.material?.unit_short_name || '–µ–¥',
        volume: volume,
        consumptionRate: consumptionRate,
        workPrice: 0,
        materialPrice: materialPrice,
        deliveryPrice: deliveryPrice,
        total: materialTotal,
        groupId: rateId
      }
    })

    // –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏: —Ä–∞–±–æ—Ç–∞ + —Å—É–º–º–∞ –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    const worksCost = rate.base_price || 0
    const materialsCost = materials.reduce((sum, mat) => sum + mat.total, 0)
    const totalSum = worksCost + materialsCost

    // –û–±–Ω–æ–≤–ª—è–µ–º total –≤ contractor —Å —É—á–µ—Ç–æ–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
    contractor.total = totalSum
    contractor.materialPrice = materialsCost

    return {
      id: rateId,
      contractor,
      works: [work],
      materials,
      totalSum,
      isExpanded: false
    }
  })
}

const categoryOptions = [
  {
    value: '–æ–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã',
    label: '–û–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã',
    color: 'blue',
  },
  { value: '—Ñ–∞—Å–∞–¥–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã', label: '–§–∞—Å–∞–¥–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', color: 'green' },
  { value: '–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', label: '–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', color: 'orange' },
  { value: '–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã', label: '–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', color: 'purple' },
  { value: '–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', label: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', color: 'cyan' },
  { value: '–º–∞—Ç–µ—Ä–∏–∞–ª', label: '–ú–∞—Ç–µ—Ä–∏–∞–ª', color: 'red' },
  {
    value: '—ç–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã',
    label: '–≠–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂–Ω—ã–µ —Ä–∞–±–æ—Ç—ã',
    color: 'gold',
  },
  { value: '—Å–ª–∞–±–æ—Ç–æ—á–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã', label: '–°–ª–∞–±–æ—Ç–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', color: 'lime' },
  {
    value: '–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ_—Ä–∞–±–æ—Ç—ã',
    label: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã',
    color: 'magenta',
  },
  { value: '–∑–µ–º–ª—è–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã', label: '–ó–µ–º–ª—è–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', color: 'volcano' },
  {
    value: '–≤—Ä–µ–º–µ–Ω–Ω—ã–µ_–∑–¥–∞–Ω–∏—è_—Å–æ–æ—Ä—É–∂–µ–Ω–∏—è',
    label: '–í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è/—Å–æ–æ—Ä—É–∂–µ–Ω–∏—è',
    color: 'geekblue',
  },
]

function Rates() {
  const { message } = App.useApp()
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [isMaterialModalOpen, setIsMaterialModalOpen] = useState(false)
  const [isAddModalVisible, setIsAddModalVisible] = useState(false)
  const [editingRate, setEditingRate] = useState<RateWithUnit | null>(null)
  const [selectedRateForMaterial, setSelectedRateForMaterial] = useState<RateWithUnit | null>(null)
  const [form] = Form.useForm<RateFormData>()
  const [materialForm] = Form.useForm<MaterialFormData>()
  const [searchText, setSearchText] = useState('')
  const [categoryFilter, setCategoryFilter] = useState<string>()
  const [rateGroups, setRateGroups] = useState<RateGroup[]>([])
  const [exportingGroup, setExportingGroup] = useState<string | null>(null)

  const queryClient = useQueryClient()
  const logger = usePortalLogger()

  const { data: rates = [], isLoading, refetch: refetchRates } = useQuery({
    queryKey: ['rates'],
    queryFn: ratesApi.getAll,
  })

  const { data: units = [], isLoading: unitsLoading } = useQuery({
    queryKey: ['units'],
    queryFn: unitsApi.getAll,
  })

  const { data: materials = [], isLoading: materialsLoading } = useQuery({
    queryKey: ['materials'],
    queryFn: materialsApi.getAll,
  })

  // –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ä–∞—Å—Ü–µ–Ω–æ–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–µ—Ä–∞—Ä—Ö–∏–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
  const { data: rawRateMaterials = [], isLoading: rateMaterialsLoading, refetch: refetchRateMaterials } = useQuery({
    queryKey: ['rateMaterials', 'all'],
    queryFn: async () => {
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —Ä–∞—Å—Ü–µ–Ω–∫–∞–º–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
      const { data, error } = await supabase
        .from('rate_materials_mapping')
        .select(`
          *,
          material:materials (
            id,
            code,
            name,
            description,
            unit_id,
            unit_name,
            unit_short_name,
            last_purchase_price,
            supplier,
            supplier_article,
            is_active
          )
        `)
        .order('created_at', { ascending: true })

      console.log('Optimized rate materials query:', {
        action: 'load_all_rate_materials_optimized',
        timestamp: new Date().toISOString(),
        success: !error,
        dataCount: data?.length || 0,
        error: error?.message,
      })

      if (error) {
        console.error('Get all rate materials error:', error)
        throw error
      }

      return data || []
    },
    enabled: true,
  })

  // –ú–µ–º–æ–∏–∑–∏—Ä—É–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ä–µ—Ä–µ–Ω–¥–µ—Ä–æ–≤
  const allRateMaterials = React.useMemo(() => {
    const grouped: Record<string, RateMaterial[]> = {}
    rawRateMaterials.forEach((rateMaterial) => {
      if (!grouped[rateMaterial.rate_id]) {
        grouped[rateMaterial.rate_id] = []
      }
      grouped[rateMaterial.rate_id].push(rateMaterial)
    })
    return grouped
  }, [rawRateMaterials])

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –≤ —Ñ–æ—Ä–º–∞—Ç RateGroup –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞—Å—Ü–µ–Ω–æ–∫ –≤ –≥—Ä—É–ø–ø—ã
  React.useEffect(() => {
    if (rates.length > 0 && !rateMaterialsLoading) {
      const groups = convertRatesToGroups(rates, allRateMaterials)
      setRateGroups(groups)
      console.log('Rate groups converted:', {
        ratesCount: rates.length,
        groupsCount: groups.length,
        materialsCount: Object.keys(allRateMaterials).length
      })
    }
  }, [rates, rawRateMaterials, rateMaterialsLoading])

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
  React.useEffect(() => {
    if (rates.length > 0) {
      logger.logView('rates', undefined, `–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–±–æ—Ä–Ω–∏–∫–∞ —Ä–∞—Å—Ü–µ–Ω–æ–∫ —Å ${rates.length} —Ä–∞—Å—Ü–µ–Ω–∫–∞–º–∏`)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã rate_materials_mapping
  React.useEffect(() => {
    const checkTable = async () => {
      try {
        const { data, error } = await supabase
          .from('rate_materials_mapping')
          .select('id')
          .limit(1)
        
        console.log('Table rate_materials_mapping check:', {
          exists: !error,
          error: error?.message,
          data: data
        })
        
        if (error) {
          console.error('‚ö†Ô∏è  –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –¢–∞–±–ª–∏—Ü–∞ rate_materials_mapping –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!')
          console.error('–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase Dashboard!')
        }
      } catch (err) {
        console.error('Database connection error:', err)
      }
    }
    
    checkTable()
  }, [])

  const createMutation = useMutation({
    mutationFn: ratesApi.create,
    onSuccess: async data => {
      console.log('‚úÖ Rate created successfully:', data)
      console.log('üîµ tempRateMaterials at creation:', {
        length: tempRateMaterials.length,
        materials: tempRateMaterials,
        hasDataId: !!data.id
      })

      // –°–≤—è–∑—ã–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –Ω–æ–≤–æ–π —Ä–∞—Å—Ü–µ–Ω–∫–æ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      if (tempRateMaterials.length > 0 && data.id) {
        console.log('üîµ Will save materials because tempRateMaterials.length > 0 and data.id exists')
        try {
          const rateMaterialsToCreate = tempRateMaterials.map((material, index) => {
            const materialId = material.id.startsWith('catalog-')
              ? (material as any).originalId || material.id.replace('catalog-', '')
              : material.id

            console.log(`üîµ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ ${index + 1}/${tempRateMaterials.length}:`, {
              originalMaterial: {
                id: material.id,
                originalId: (material as any).originalId,
                code: material.code,
                name: material.name,
                consumption: material.consumption,
                price: material.last_purchase_price
              },
              extractedMaterialId: materialId
            })

            return {
              rate_id: data.id,
              material_id: materialId,
              consumption: material.consumption || 1,
              unit_price: material.last_purchase_price || 0,
              notes: `–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∏`
            }
          })

          // –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ material_id
          const uniqueMaterialIds = new Set<string>()
          const uniqueRateMaterials = rateMaterialsToCreate.filter(item => {
            if (uniqueMaterialIds.has(item.material_id)) {
              console.log('‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç material_id, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', {
                materialId: item.material_id,
                rateId: item.rate_id
              })
              return false
            }
            uniqueMaterialIds.add(item.material_id)
            return true
          })

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
          console.log('üîµ –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –ë–î:', {
            rateId: data.id,
            totalMaterials: rateMaterialsToCreate.length,
            uniqueMaterials: uniqueRateMaterials.length,
            duplicatesRemoved: rateMaterialsToCreate.length - uniqueRateMaterials.length,
            materials: uniqueRateMaterials
          })

          if (uniqueRateMaterials.length !== rateMaterialsToCreate.length) {
            message.warning(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–æ ${rateMaterialsToCreate.length - uniqueRateMaterials.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤`)
          }

          const savedMaterials = await rateMaterialsApi.createMany(uniqueRateMaterials)

          console.log('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î:', {
            rateId: data.id,
            materialsCount: uniqueRateMaterials.length,
            savedMaterials: savedMaterials
          })
          
          // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
          setTempRateMaterials([])
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ä–∞—Å—Ü–µ–Ω–∫—É
          window.setTimeout(() => {
            setExpandedRates(prev => new Set([...prev, data.id]))
          }, 100)
          
        } catch (materialError) {
          console.error('‚ùå Error saving materials to database:', {
            error: materialError,
            message: materialError?.message,
            details: materialError?.details,
            hint: materialError?.hint,
            code: materialError?.code,
            rateId: data.id,
            materialsCount: tempRateMaterials.length
          })
          message.warning('–†–∞—Å—Ü–µ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤')
        }
      } else {
        console.log('‚ö†Ô∏è  Skipping material save:', {
          reason: tempRateMaterials.length === 0 ? 'No materials to save' : 'Missing rate ID',
          tempRateMaterialsLength: tempRateMaterials.length,
          hasDataId: !!data.id
        })
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      await queryClient.invalidateQueries({ queryKey: ['rates'] })
      await queryClient.invalidateQueries({ queryKey: ['rateMaterials', 'all'] })

      console.log('‚úÖ Cache invalidated, queries will reload')

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      await refetchRates()
      await refetchRateMaterials()

      console.log('‚úÖ Data refetched successfully')

      // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
      setTempRateMaterials([])

      message.success('–†–∞—Å—Ü–µ–Ω–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞')

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
      if (isModalOpen) {
        handleCloseModal()
      }
    },
    onError: error => {
      console.error('Create error details:', {
        error,
        message: error.message,
        timestamp: new Date().toISOString(),
      })
      message.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∏: ${error.message}`)
    },
  })

  const updateMutation = useMutation({
    mutationFn: ({ id, data }: { id: string; data: RateUpdate }) =>
      ratesApi.update(id, data),
    onSuccess: async (data, variables) => {
      console.log('Rate updated successfully:', data)
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞—Å—Ü–µ–Ω–∫–∏
      if (tempRateMaterials.length > 0 && variables.id) {
        try {
          // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞—Å—Ü–µ–Ω–∫–∏
          await rateMaterialsApi.deleteByRateId(variables.id)
          console.log('Old materials deleted for rate:', variables.id)
          
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
          const rateMaterialsToCreate = tempRateMaterials.map(material => {
            const materialId = material.id.startsWith('catalog-')
              ? (material as any).originalId || material.id.replace('catalog-', '')
              : (material as any).originalId || material.id

            return {
              rate_id: variables.id,
              material_id: materialId,
              consumption: material.consumption || 1,
              unit_price: material.last_purchase_price || 0,
              notes: `–ú–∞—Ç–µ—Ä–∏–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∏`
            }
          })

          // –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ material_id
          const uniqueMaterialIds = new Set<string>()
          const uniqueRateMaterials = rateMaterialsToCreate.filter(item => {
            if (uniqueMaterialIds.has(item.material_id)) {
              console.log('‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç material_id –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', {
                materialId: item.material_id,
                rateId: item.rate_id
              })
              return false
            }
            uniqueMaterialIds.add(item.material_id)
            return true
          })

          console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ä–∞—Å—Ü–µ–Ω–∫–∏:', {
            rateId: variables.id,
            totalMaterials: rateMaterialsToCreate.length,
            uniqueMaterials: uniqueRateMaterials.length,
            duplicatesRemoved: rateMaterialsToCreate.length - uniqueRateMaterials.length,
            materials: uniqueRateMaterials
          })

          if (uniqueRateMaterials.length !== rateMaterialsToCreate.length) {
            message.warning(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–æ ${rateMaterialsToCreate.length - uniqueRateMaterials.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤`)
          }

          await rateMaterialsApi.createMany(uniqueRateMaterials)
          console.log('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞—Å—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã')
          
        } catch (materialError) {
          console.error('Error updating rate materials:', materialError)
          message.warning('–†–∞—Å—Ü–µ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤')
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
      await queryClient.invalidateQueries({ queryKey: ['rates'] })
      await queryClient.invalidateQueries({ queryKey: ['rateMaterials', 'all'] })
      
      message.success('–†–∞—Å—Ü–µ–Ω–∫–∞ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã')
      handleCloseModal()
    },
    onError: error => {
      console.error('Update error details:', {
        error,
        message: error.message,
        timestamp: new Date().toISOString(),
      })
      message.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∏: ${error.message}`)
    },
  })

  const deleteMutation = useMutation({
    mutationFn: ratesApi.delete,
    onSuccess: () => {
      console.log('Rate deleted successfully')
      queryClient.invalidateQueries({ queryKey: ['rates'] })
      message.success('–†–∞—Å—Ü–µ–Ω–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞')
    },
    onError: error => {
      console.error('Delete error details:', {
        error,
        message: error.message,
        timestamp: new Date().toISOString(),
      })
      message.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∏: ${error.message}`)
    },
  })

  // –ú—É—Ç–∞—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
  const createMaterialMutation = useMutation({
    mutationFn: materialsApi.create,
    onSuccess: data => {
      console.log('Material created successfully:', data)
      queryClient.invalidateQueries({ queryKey: ['materials'] })
      message.success('–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω')
      handleCloseMaterialModal()
    },
    onError: error => {
      console.error('Create material error details:', {
        error,
        message: error.message,
        timestamp: new Date().toISOString(),
      })
      message.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ${error.message}`)
    },
  })

  const handleAdd = () => {
    console.log('Add rate clicked', {
      action: 'add_rate',
      timestamp: new Date().toISOString(),
    })

    setEditingRate(null)
    form.resetFields()

    const defaultCategory = '–æ–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã'
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    const existingCodes = rates.map(r => r.code)
    const generatedCode = generateRateCode(defaultCategory, existingCodes)

    form.setFieldsValue({
      is_active: true,
      category: defaultCategory,
      base_price: 0,
      code: generatedCode,
    })
    setTempRateMaterials([])
    setActiveTab('1')
    setIsModalOpen(true)
  }

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –≤ –º–æ–¥–∞–ª–∫–µ
  const addTempMaterial = () => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultUnit = units[0]
    
    const newMaterial: MaterialWithUnit & { consumption?: number } = {
      id: `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      code: `–ú–¢-${String(tempRateMaterials.length + 1).padStart(3, '0')}`,
      name: '',
      description: '',
      category: 'material',
      unit_id: defaultUnit?.id || '',
      unit_name: defaultUnit?.name || '',
      unit_short_name: defaultUnit?.short_name || '',
      last_purchase_price: 0,
      consumption: 1, // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ —Ä–∞—Å—Ö–æ–¥–∞
      supplier: '',
      supplier_article: '',
      is_active: true,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    }
    setTempRateMaterials(prev => {
      const updated = [...prev, newMaterial]
      console.log('Material added to temp list:', { newMaterial, totalCount: updated.length })
      return updated
    })
  }

  const addMaterialFromCatalog = (selectedMaterialId: string) => {
    console.log('addMaterialFromCatalog called with ID:', selectedMaterialId)

    const selectedMaterial = materials.find(m => m.id === selectedMaterialId)
    if (!selectedMaterial) {
      console.error('Material not found:', selectedMaterialId)
      message.error('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω')
      return
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª (–ø–æ originalId)
    const isAlreadyAdded = tempRateMaterials.some(m => {
      const existingMaterialId = m.id.startsWith('catalog-')
        ? ((m as any).originalId || m.id.replace('catalog-', ''))
        : (m.id.startsWith('temp-') ? null : m.id)

      return existingMaterialId === selectedMaterial.id
    })

    if (isAlreadyAdded) {
      console.log('‚ùå –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞:', {
        materialId: selectedMaterial.id,
        code: selectedMaterial.code,
        name: selectedMaterial.name,
        timestamp: new Date().toISOString()
      })
      message.warning(`–ú–∞—Ç–µ—Ä–∏–∞–ª "${selectedMaterial.code} - ${selectedMaterial.name}" —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ä–∞—Å—Ü–µ–Ω–∫—É`)
      setSelectedCatalogMaterial(undefined) // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      return
    }

    console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞:', {
      materialId: selectedMaterial.id,
      code: selectedMaterial.code,
      name: selectedMaterial.name,
      timestamp: new Date().toISOString()
    })

    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å –º–µ—Ç–∫–æ–π
    const materialFromCatalog: MaterialWithUnit & { consumption?: number; originalId?: string } = {
      ...selectedMaterial,
      id: `catalog-${selectedMaterial.id}`, // –ú–µ—Ç–∫–∞ —á—Ç–æ —ç—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
      originalId: selectedMaterial.id, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID
      consumption: 1, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–∞
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
      unit_id: selectedMaterial.unit_id,
      unit_name: selectedMaterial.unit_name,
      unit_short_name: selectedMaterial.unit_short_name,
    }

    setTempRateMaterials(prev => {
      const updated = [...prev, materialFromCatalog]
      console.log('Material from catalog added to temp list:', {
        materialFromCatalog,
        totalCount: updated.length,
        selectedMaterial: selectedMaterial.name
      })
      return updated
    })

    message.success(`–ú–∞—Ç–µ—Ä–∏–∞–ª "${selectedMaterial.name}" –¥–æ–±–∞–≤–ª–µ–Ω`)
    setSelectedCatalogMaterial(undefined) // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  }

  const removeTempMaterial = (materialId: string) => {
    setTempRateMaterials(prev => prev.filter(m => m.id !== materialId))
  }

  const updateTempMaterial = (materialId: string, field: string, value: any) => {
    setTempRateMaterials(prev => prev.map(material => 
      material.id === materialId 
        ? { ...material, [field]: value, updated_at: new Date().toISOString() }
        : material
    ))
  }

  const handleEdit = async (rate: RateWithUnit) => {
    console.log('Edit rate clicked', {
      action: 'edit_rate',
      rateId: rate.id,
      rateName: rate.name,
      timestamp: new Date().toISOString(),
    })

    setEditingRate(rate)
    form.setFieldsValue(rate)
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ä–∞—Å—Ü–µ–Ω–∫–∏
    try {
      const rateMaterials = await rateMaterialsApi.getByRateId(rate.id)
      console.log('Loaded materials for editing rate:', {
        rateId: rate.id,
        materialsCount: rateMaterials.length,
        materials: rateMaterials
      })
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      const tempMaterials = rateMaterials.map(rateMaterial => ({
        id: rateMaterial.material?.id || rateMaterial.material_id,
        code: rateMaterial.material?.code || '',
        name: rateMaterial.material?.name || '',
        description: rateMaterial.material?.description || '',
        category: 'material' as const,
        unit_id: rateMaterial.material?.unit_id || '', // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        unit_name: rateMaterial.material?.unit_name || '',
        unit_short_name: rateMaterial.material?.unit_short_name || '',
        last_purchase_price: rateMaterial.unit_price,
        supplier: rateMaterial.material?.supplier || '',
        supplier_article: rateMaterial.material?.supplier_article || '',
        is_active: rateMaterial.material?.is_active ?? true,
        created_at: rateMaterial.created_at,
        updated_at: rateMaterial.updated_at,
        consumption: rateMaterial.consumption,
        originalId: rateMaterial.material?.id || rateMaterial.material_id,
        rateMaterialId: rateMaterial.id // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      }))
      
      setTempRateMaterials(tempMaterials)
      setActiveTab('1') // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
      
    } catch (error) {
      console.error('Error loading materials for rate editing:', error)
      setTempRateMaterials([]) // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
    }
    
    setIsModalOpen(true)
  }

  const handleDelete = (id: string) => {
    console.log('Delete rate clicked', {
      action: 'delete_rate',
      rateId: id,
      timestamp: new Date().toISOString(),
    })

    deleteMutation.mutate(id)
  }

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–ª–æ–∫–∞–º–∏ —Ä–∞—Å—Ü–µ–Ω–æ–∫ (–Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
  const handleEditGroup = (groupId: string) => {
    console.log('handleEditGroup called with groupId:', groupId)
    const rate = rates.find(r => r.id === groupId)
    console.log('Found rate:', rate)

    if (rate) {
      // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      logger.logButtonClick('–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É', '–°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫', {
        rateId: groupId,
        rateName: rate.name
      })
      console.log('Calling handleEdit with rate:', rate)
      handleEdit(rate)
    } else {
      console.error('Rate not found for groupId:', groupId)
      message.error('–†–∞—Å—Ü–µ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
    }
  }

  const handleDeleteGroup = (groupId: string) => {
    const rate = rates.find(r => r.id === groupId)
    // –õ–æ–≥–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏
    logger.logButtonClick('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É', '–°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫', {
      rateId: groupId,
      rateName: rate?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    })
    handleDelete(groupId)
  }

  const handleDuplicateGroup = (groupId: string) => {
    const rate = rates.find(r => r.id === groupId)
    if (rate) {
      // –õ–æ–≥–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏
      logger.logButtonClick('–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É', '–°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫', {
        originalRateId: groupId,
        originalRateName: rate.name
      })

      // –°–æ–∑–¥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç —Ä–∞—Å—Ü–µ–Ω–∫–∏
      const duplicateData = {
        code: `${rate.code}-–ö–û–ü–ò–Ø`,
        name: `${rate.name} (–∫–æ–ø–∏—è)`,
        description: rate.description,
        unit_id: rate.unit_id,
        base_price: rate.base_price,
        category: rate.category,
        subcategory: rate.subcategory,
        is_active: rate.is_active
      }

      createMutation.mutate(duplicateData)
      message.success('–†–∞—Å—Ü–µ–Ω–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∞')

      // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞—Å—Ü–µ–Ω–∫–∏
      logger.logCreate('rates', 'new-duplicate', duplicateData, `–°–æ–∑–¥–∞–Ω–∞ –∫–æ–ø–∏—è —Ä–∞—Å—Ü–µ–Ω–∫–∏ "${rate.name}"`)
    }
  }

  const handleUpdateGroupPosition = async (positionId: string, updates: Partial<RatePosition>) => {
    console.log('Position update requested:', { positionId, updates })

    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    logger.logButtonClick('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è —Ä–∞—Å—Ü–µ–Ω–∫–∏', '–°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫', {
      positionId,
      updates,
      action: 'inline_edit'
    })

    // –ù–∞–π–¥–µ–º –≥—Ä—É–ø–ø—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é
    const group = rateGroups.find(g =>
      g.contractor.id === positionId ||
      g.works.some(w => w.id === positionId) ||
      g.materials.some(m => m.id === positionId)
    )

    if (!group) {
      message.error('–ì—Ä—É–ø–ø–∞ —Ä–∞—Å—Ü–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
      return
    }

    const rate = rates.find(r => r.id === group.id)
    if (!rate) {
      message.error('–†–∞—Å—Ü–µ–Ω–∫–∞ –≤ –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞')
      return
    }

    try {
      // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (–∑–∞–∫–∞–∑—á–∏–∫ –∏–ª–∏ —Ä–∞–±–æ—Ç–∞), –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—Ü–µ–Ω–∫—É –≤ –ë–î
      if (positionId === group.contractor.id || positionId === group.works[0]?.id) {
        const updateData: Partial<RateUpdate> = {}

        if (updates.name) {
          updateData.name = updates.name
        }
        if (updates.workPrice !== undefined) {
          updateData.base_price = updates.workPrice
        }
        if (updates.unit) {
          const unit = units.find(u => u.short_name === updates.unit)
          if (unit) {
            updateData.unit_id = unit.id
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ë–î –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (Object.keys(updateData).length > 0) {
          await updateMutation.mutateAsync({
            id: group.id,
            data: updateData
          })

          // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
          await queryClient.invalidateQueries({ queryKey: ['rates'] })
          console.log('üìä Rate cache invalidated after update')
        }
      }

      // –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–∞—Ç–µ—Ä–∏–∞–ª, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É rate_materials_mapping
      const materialIndex = group.materials.findIndex(m => m.id === positionId)
      if (materialIndex !== -1) {
        try {
          const rateMaterials = allRateMaterials[group.id] || []
          if (rateMaterials[materialIndex]) {
            const rateMaterialId = rateMaterials[materialIndex].id
            const updateData = {
              consumption: updates.consumptionRate || updates.volume,
              unit_price: updates.materialPrice,
              notes: `–û–±–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ${new Date().toLocaleString()}`
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ rate_materials_mapping
            await rateMaterialsApi.update(rateMaterialId, updateData)
            console.log('üìã Material mapping updated:', { rateMaterialId, updateData })

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            await queryClient.invalidateQueries({ queryKey: ['rateMaterials', 'all'] })
          }
        } catch (materialError) {
          console.error('Error updating material mapping:', materialError)
          // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Ç–∞–∫ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–ø–ø
      setRateGroups(prev => prev.map(g => {
        if (g.id !== group.id) return g

        const updatedGroup = { ...g }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑—á–∏–∫–∞
        if (positionId === g.contractor.id) {
          updatedGroup.contractor = { ...g.contractor, ...updates }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–±–æ—Ç—ã
        updatedGroup.works = g.works.map(work =>
          work.id === positionId ? { ...work, ...updates } : work
        )

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
        updatedGroup.materials = g.materials.map(material =>
          material.id === positionId ? { ...material, ...updates } : material
        )

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
        const worksCost = updatedGroup.works.reduce((sum, w) => sum + (w.volume * w.workPrice), 0)
        const materialsCost = updatedGroup.materials.reduce((sum, m) => sum + (m.volume * m.materialPrice * m.consumptionRate), 0)
        updatedGroup.totalSum = worksCost + materialsCost

        // –û–±–Ω–æ–≤–ª—è–µ–º total –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
        updatedGroup.works = updatedGroup.works.map(w => ({
          ...w,
          total: w.volume * w.workPrice
        }))

        updatedGroup.materials = updatedGroup.materials.map(m => ({
          ...m,
          total: m.volume * m.materialPrice * m.consumptionRate + m.deliveryPrice
        }))

        updatedGroup.contractor = {
          ...updatedGroup.contractor,
          total: updatedGroup.totalSum
        }

        return updatedGroup
      }))

      message.success('–ü–æ–∑–∏—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞')
      console.log('‚úÖ Position updated successfully:', { positionId, updates })

      // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
      logger.logUpdate('rates', group.id, {}, updates, `–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏—è ${positionId} –≤ —Ä–∞—Å—Ü–µ–Ω–∫–µ "${group.contractor.name}"`)

    } catch (error) {
      console.error('Error updating position:', error)
      message.error(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error}`)
    }
  }

  const handleAddNewGroup = () => {
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    logger.logButtonClick('–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É', '–°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫')
    setIsAddModalVisible(true)
    console.log('Add new group modal opened')
  }

  const handleSaveNewGroup = async (newGroup: RateGroup) => {
    console.log('New group saved:', newGroup)

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (!newGroup.contractor.name || !newGroup.works?.[0]) {
      message.error('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Ü–µ–Ω–∫–∏')
      return
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º RateGroup –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç –ë–î –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    const rateData = {
      code: newGroup.contractor.name.replace(/\s+/g, '-').toUpperCase(),
      name: newGroup.contractor.name,
      description: newGroup.works[0]?.name ? `–í–∫–ª—é—á–∞–µ—Ç —Ä–∞–±–æ—Ç—ã: ${newGroup.works[0].name}` : '',
      unit_id: units.find(u => u.short_name === newGroup.contractor.unit)?.id || units[0]?.id || '',
      base_price: newGroup.works[0]?.workPrice || newGroup.totalSum || 0,
      category: '–æ–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ_—Ä–∞–±–æ—Ç—ã',
      is_active: true
    }

    console.log('handleSaveNewGroup: About to save rateData:', rateData)
    console.log('handleSaveNewGroup: Materials to save:', newGroup.materials)

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ onSuccess
    if (newGroup.materials && newGroup.materials.length > 0) {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const materialsToSave = newGroup.materials.map(material => ({
        id: `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        code: `MAT-${Date.now()}`,
        name: material.name || '–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª',
        description: '',
        category: 'material',
        unit_id: units.find(u => u.short_name === material.unit)?.id || units[0]?.id || '',
        unit_name: units.find(u => u.short_name === material.unit)?.name || '–µ–¥',
        unit_short_name: material.unit || '–µ–¥',
        last_purchase_price: material.materialPrice || 0,
        consumption: material.consumptionRate || 1,
        supplier: '',
        supplier_article: '',
        is_active: true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }))

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è createMutation.onSuccess
      setTempRateMaterials(materialsToSave)
    } else {
      setTempRateMaterials([])
    }

    // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞—Å—Ü–µ–Ω–∫–∏
    logger.logFormSubmit('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ä–∞—Å—Ü–µ–Ω–∫–∏', rateData, '–°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫')
    logger.logCreate('rates', 'new-rate', rateData, `–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ä–∞—Å—Ü–µ–Ω–∫–∞ "${rateData.name}"`)

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º—É—Ç–∞—Ü–∏—é —Å –µ—ë –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ onSuccess/onError
    createMutation.mutate(rateData)
    setIsAddModalVisible(false)
  }

  const handleCloseModal = () => {
    console.log('Modal closed', {
      action: 'modal_close',
      timestamp: new Date().toISOString(),
    })

    setIsModalOpen(false)
    setEditingRate(null)
    setTempRateMaterials([])
    setSelectedCatalogMaterial(undefined)
    setActiveTab('1')
    form.resetFields()
  }

  const handleAddMaterial = (rate: RateWithUnit) => {
    console.log('Add material clicked for rate:', {
      action: 'add_material_to_rate',
      rateId: rate.id,
      rateName: rate.name,
      timestamp: new Date().toISOString(),
    })

    setSelectedRateForMaterial(rate)
    materialForm.resetFields()
    materialForm.setFieldsValue({
      is_active: true,
      category: 'material',
      last_purchase_price: 0,
    })
    setIsMaterialModalOpen(true)
  }

  const handleCloseMaterialModal = () => {
    console.log('Material modal closed', {
      action: 'material_modal_close',
      timestamp: new Date().toISOString(),
    })

    setIsMaterialModalOpen(false)
    setSelectedRateForMaterial(null)
    setEditingMaterial(null)
    materialForm.resetFields()
  }

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields()

      console.log('üîµ Form submitted', {
        action: 'form_submit',
        values,
        editingRate: editingRate?.id,
        tempMaterialsCount: tempRateMaterials.length,
        tempMaterials: tempRateMaterials.map(m => ({
          id: m.id,
          originalId: (m as any).originalId,
          code: m.code,
          name: m.name,
          consumption: m.consumption
        })),
        timestamp: new Date().toISOString(),
      })

      if (editingRate) {
        console.log('üîµ Updating existing rate:', editingRate.id)
        updateMutation.mutate({
          id: editingRate.id,
          data: values,
        })
      } else {
        console.log('üîµ Creating new rate with materials:', {
          rateData: values,
          materialsCount: tempRateMaterials.length,
          materials: tempRateMaterials
        })
        // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—Ü–µ–Ω–∫—É (–º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç—Å—è –≤ onSuccess –∫–æ–ª–±–µ–∫–µ)
        createMutation.mutate(values)
      }
    } catch (error) {
      console.error('‚ùå Form validation error:', error)
      message.error('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã')
    }
  }

  const handleMaterialSubmit = async () => {
    try {
      const values = await materialForm.validateFields()

      console.log('Material form submitted', {
        action: 'material_form_submit',
        values,
        editingMaterial: editingMaterial?.id,
        selectedRateId: selectedRateForMaterial?.id,
        timestamp: new Date().toISOString(),
      })

      // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è
      const unit = units.find(u => u.id === values.unit_id)
      
      if (editingMaterial) {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ - TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        console.log('Material editing not yet implemented for database persistence')
        message.info('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ')
      } else if (selectedRateForMaterial) {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ - TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        console.log('Individual material addition not yet implemented for database persistence')
        message.info('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Ü–µ–Ω–∫–∏.')
      }
      
      handleCloseMaterialModal()
    } catch (error) {
      console.error('Material form validation error:', error)
      message.error('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞')
    }
  }

  const handleSearch = (value: string) => {
    console.log('Search triggered', {
      action: 'search',
      searchText: value,
      timestamp: new Date().toISOString(),
    })
    // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    logger.logView('rates', undefined, `–ü–æ–∏—Å–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${value}"`)
    setSearchText(value)
  }

  const handleCategoryFilter = (category: string) => {
    console.log('Category filter changed', {
      action: 'filter_category',
      category,
      timestamp: new Date().toISOString(),
    })
    // –õ–æ–≥–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    logger.logView('rates', undefined, `–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞—Å—Ü–µ–Ω–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "${category}"`)
    setCategoryFilter(category)
  }

  const getCategoryConfig = (category: string) => {
    return (
      categoryOptions.find(option => option.value === category) ||
      categoryOptions[0]
    )
  }

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–∫—Ä—ã—Ç—ã–º–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∞–º–∏
  const [expandedRates, setExpandedRates] = useState<Set<string>>(new Set())
  const [editingMaterial, setEditingMaterial] = useState<(MaterialWithUnit & { parentRateId?: string }) | null>(null)
  const [tempRateMaterials, setTempRateMaterials] = useState<(MaterialWithUnit & { consumption?: number; originalId?: string })[]>([])
  const [selectedCatalogMaterial, setSelectedCatalogMaterial] = useState<string | undefined>(undefined)
  const [activeTab, setActiveTab] = useState<string>('1')
  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set())

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const toggleCategoryExpansion = (categoryValue: string) => {
    console.log('Toggle category expansion:', {
      action: 'toggle_category',
      categoryValue,
      isCurrentlyExpanded: expandedCategories.has(categoryValue),
      timestamp: new Date().toISOString(),
    })

    setExpandedCategories(prev => {
      const newSet = new Set(prev)
      if (newSet.has(categoryValue)) {
        newSet.delete(categoryValue)
      } else {
        newSet.add(categoryValue)
      }
      return newSet
    })
  }

  // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
  const addExampleMaterials = (rateId: string) => {
    if (!units.length) return
    
    const exampleMaterials = [
      {
        id: `example-${rateId}-1`,
        code: '–ú–¢-001',
        name: '–ö–∏—Ä–ø–∏—á –æ–±–ª–∏—Ü–æ–≤–æ—á–Ω—ã–π',
        description: '–ö–∏—Ä–ø–∏—á –æ–±–ª–∏—Ü–æ–≤–æ—á–Ω—ã–π –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–∏–π',
        category: 'brick',
        unit_id: units[0]?.id || '',
        unit_name: units[0]?.name || '—à—Ç.',
        unit_short_name: units[0]?.short_name || '—à—Ç.',
        last_purchase_price: 15.50,
        supplier: '–ö–∏—Ä–ø–∏—á–Ω—ã–π –∑–∞–≤–æ–¥ –Ω–æ. 1',
        supplier_article: '–ö–û-150',
        is_active: true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      },
      {
        id: `example-${rateId}-2`,
        code: '–ú–¢-002',
        name: '–¶–µ–º–µ–Ω—Ç –ú400',
        description: '–ü–æ—Ä—Ç–ª–∞–Ω–¥—Ü–µ–º–µ–Ω—Ç –ú400 –î–æ',
        category: 'concrete',
        unit_id: units[1]?.id || units[0]?.id || '',
        unit_name: units[1]?.name || units[0]?.name || '–∫–≥',
        unit_short_name: units[1]?.short_name || units[0]?.short_name || '–∫–≥',
        last_purchase_price: 280.00,
        supplier: '–õ–∞—Ñ–∞—Ä–∂ –¶–µ–º–µ–Ω—Ç',
        supplier_article: 'LF-M400-50',
        is_active: true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      }
    ]
    
    // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ –ë–î
    console.log('Example materials addition not yet implemented for database persistence')
    message.info('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ')
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Ä–∞—Å—Ü–µ–Ω–∫–∏
  const toggleRateExpansion = (rateId: string) => {
    const newExpanded = new Set(expandedRates)
    if (newExpanded.has(rateId)) {
      newExpanded.delete(rateId)
    } else {
      newExpanded.add(rateId)
    }
    setExpandedRates(newExpanded)
  }

  const filteredRates = rates.filter(rate => {
    const matchesSearch =
      !searchText ||
      rate.code.toLowerCase().includes(searchText.toLowerCase()) ||
      rate.name.toLowerCase().includes(searchText.toLowerCase())

    const matchesCategory = !categoryFilter || rate.category === categoryFilter

    return matchesSearch && matchesCategory
  })

  // –§–∏–ª—å—Ç—Ä—É–µ–º –≥—Ä—É–ø–ø—ã —Ä–∞—Å—Ü–µ–Ω–æ–∫
  const filteredGroups = rateGroups.filter(group => {
    const matchesSearch =
      !searchText ||
      group.contractor.name.toLowerCase().includes(searchText.toLowerCase()) ||
      group.works.some(w => w.name.toLowerCase().includes(searchText.toLowerCase())) ||
      group.materials.some(m => m.name.toLowerCase().includes(searchText.toLowerCase()))

    const rate = rates.find(r => r.id === group.id)
    const matchesCategory = !categoryFilter || (rate && rate.category === categoryFilter)

    return matchesSearch && matchesCategory
  })

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∫–æ–Ω—Å–æ–ª–∏)
  const formatCurrency = (amount: number): string => {
    return amount.toLocaleString('ru-RU', {
      style: 'currency',
      currency: 'RUB',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    })
  }

  const getTotalCost = (groups: RateGroup[]): number => {
    return groups.reduce((total, group) => total + group.totalSum, 0)
  }

  const totalCost = getTotalCost(filteredGroups)
  const totalWorksCost = filteredGroups.reduce((sum, group) =>
    sum + group.works.reduce((workSum, work) => workSum + work.total, 0), 0
  )
  const totalMaterialsCost = filteredGroups.reduce((sum, group) =>
    sum + group.materials.reduce((materialSum, material) => materialSum + material.total, 0), 0
  )

  // –¢–∏–ø—ã –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
  type HierarchicalDataItem = (RateWithUnit & {
    isParentRate?: boolean;
    isExpanded?: boolean;
  }) | (MaterialWithUnit & {
    isChildMaterial: true;
    parentRateId: string;
    level: number;
    materialIndex: number;
    rateMaterialId?: string;
    consumption?: number;
  });

  // –°–æ–∑–¥–∞–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
  const createHierarchicalData = () => {
    const result: HierarchicalDataItem[] = []
    
    filteredRates.forEach(rate => {
      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞—Å—Ü–µ–Ω–∫—É (—Ä–∞–±–æ—Ç—É)
      result.push({
        ...rate,
        isParentRate: true,
        isExpanded: expandedRates.has(rate.id)
      })
      
      // –ï—Å–ª–∏ —Ä–∞—Å—Ü–µ–Ω–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –º–∞—Ç–µ—Ä–∏–∞–ª—ã
      if (expandedRates.has(rate.id)) {
        const rateLinkedMaterials = allRateMaterials[rate.id] || []
        rateLinkedMaterials.forEach((rateMaterial, index) => {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º RateMaterial –≤ MaterialWithUnit —Ñ–æ—Ä–º–∞—Ç
          if (rateMaterial.material) {
            result.push({
              id: rateMaterial.material.id,
              code: rateMaterial.material.code,
              name: rateMaterial.material.name,
              description: rateMaterial.material.description,
              category: 'material', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
              unit_id: rateMaterial.material.unit_id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞
              unit_name: rateMaterial.material.unit_name, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞
              unit_short_name: rateMaterial.material.unit_short_name, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞
              last_purchase_price: rateMaterial.unit_price,
              is_active: rateMaterial.material.is_active,
              created_at: rateMaterial.created_at,
              updated_at: rateMaterial.updated_at,
              consumption: rateMaterial.consumption,
              isChildMaterial: true,
              parentRateId: rate.id,
              level: 1,
              materialIndex: index,
              rateMaterialId: rateMaterial.id // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            })
          }
        })
      }
    })
    
    return result
  }

  const hierarchicalData = createHierarchicalData()

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
  const handleEditMaterial = (material: any) => {
    console.log('Edit material clicked', {
      action: 'edit_material',
      materialId: material.id,
      materialName: material.name,
      parentRateId: material.parentRateId,
      timestamp: new Date().toISOString(),
    })

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    setEditingMaterial({ ...material })
    materialForm.setFieldsValue(material)
    setIsMaterialModalOpen(true)
  }

  const handleDeleteMaterial = (material: any) => {
    console.log('Delete material clicked', {
      action: 'delete_material',
      materialId: material.id,
      materialName: material.name,
      parentRateId: material.parentRateId,
      timestamp: new Date().toISOString(),
    })

    // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ –ë–î
    console.log('Material deletion not yet implemented for database persistence')
    message.info('–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ')
  }

  const columns = [
    {
      title: '–ö–æ–¥/–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',
      dataIndex: 'code',
      key: 'code',
      render: (code: string, record: any) => {
        const isParent = !record.isChildMaterial
        const marginLeft = isParent ? 0 : 32
        
        if (isParent) {
          // –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Ä–∞—Å—Ü–µ–Ω–∫–∞ (—Ä–∞–±–æ—Ç–∞)
          return (
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <Button
                type="text"
                size="small"
                icon={record.isExpanded ? <DownOutlined /> : <RightOutlined />}
                onClick={() => toggleRateExpansion(record.id)}
                style={{ padding: 0, minWidth: 20 }}
              />
              <div style={{ fontWeight: 600, color: '#1890ff' }}>
                <div>{code}</div>
                <div style={{ fontSize: '12px', color: '#666', fontWeight: 'normal' }}>
                  {record.name}
                </div>
              </div>
            </div>
          )
        } else {
          // –î–æ—á–µ—Ä–Ω–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª
          return (
            <div style={{ marginLeft, color: '#666' }}>
              <div style={{ fontSize: '12px' }}>‚îú‚îÄ {code}</div>
              <div style={{ fontSize: '11px', color: '#999' }}>{record.name}</div>
            </div>
          )
        }
      },
    },
    {
      title: '–û–ø–∏—Å–∞–Ω–∏–µ',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
      render: (description: string, record: any) => (
        <span style={{ color: record.isChildMaterial ? '#999' : 'inherit' }}>
          {description || '-'}
        </span>
      ),
    },
    {
      title: '–°–æ—Å—Ç–∞–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤',
      key: 'materials_composition',
      width: 320,
      render: (_: any, record: HierarchicalDataItem) => {
        if ('isChildMaterial' in record && record.isChildMaterial) {
          return null
        }
        
        // –ù–∞–π—Ç–∏ –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —ç—Ç–æ–π —Ä–∞—Å—Ü–µ–Ω–∫–∏ –∏–∑ hierarchicalData
        const rateMaterials = hierarchicalData.filter(item => 
          'isChildMaterial' in item && item.isChildMaterial && 
          'parentRateId' in item && item.parentRateId === record.id
        )
        
        console.log('Materials for rate', record.id, {
          rateMaterials,
          allRateMaterials,
          hierarchicalDataCount: hierarchicalData.length,
          fromAllRateMaterials: allRateMaterials[record.id]
        })
        
        if (rateMaterials.length === 0) {
          return (
            <div style={{ 
              padding: '8px 12px', 
              backgroundColor: '#fafafa', 
              border: '1px dashed #d9d9d9', 
              borderRadius: '6px',
              textAlign: 'center'
            }}>
              <span style={{ color: '#999', fontSize: '12px' }}>
                üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
              </span>
            </div>
          )
        }
        
        return (
          <div style={{ 
            fontSize: '11px', 
            backgroundColor: '#f6ffed', 
            border: '1px solid #b7eb8f', 
            borderRadius: '6px',
            padding: '8px'
          }}>
            <div style={{ 
              fontWeight: 600, 
              color: '#52c41a', 
              marginBottom: '6px',
              fontSize: '12px'
            }}>
              üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: {rateMaterials.length}
            </div>
            
            {rateMaterials.map((material, index) => {
              if (!('isChildMaterial' in material) || !material.isChildMaterial) return null
              
              const consumption = material.consumption || 1
              const price = material.last_purchase_price || 0
              const totalCost = price * consumption
              
              return (
                <div 
                  key={material.id} 
                  style={{ 
                    marginBottom: index < rateMaterials.length - 1 ? 6 : 0,
                    padding: '4px 6px',
                    backgroundColor: 'white',
                    border: '1px solid #e8f5e8',
                    borderRadius: '4px'
                  }}
                >
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center' 
                  }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ color: '#1890ff', fontWeight: 600, fontSize: '12px' }}>
                        {material.code}
                      </div>
                      <div style={{ 
                        color: '#262626', 
                        fontSize: '11px',
                        maxWidth: '180px',
                        whiteSpace: 'nowrap',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis'
                      }}>
                        {material.name}
                      </div>
                    </div>
                    <div style={{ textAlign: 'right', marginLeft: '8px' }}>
                      <div style={{ color: '#722ed1', fontWeight: 600, fontSize: '11px' }}>
                        {consumption} {material.unit_short_name}
                      </div>
                      <div style={{ color: '#52c41a', fontWeight: 600, fontSize: '11px' }}>
                        {totalCost.toFixed(2)} ‚ÇΩ
                      </div>
                    </div>
                  </div>
                </div>
              )
            })}
            
            <div style={{ 
              marginTop: 8, 
              paddingTop: 6, 
              borderTop: '2px solid #52c41a',
              textAlign: 'center'
            }}>
              <span style={{ color: '#52c41a', fontWeight: 700, fontSize: '13px' }}>
                üí∞ –ò—Ç–æ–≥–æ: {rateMaterials.reduce((sum, m) => {
                  if ('isChildMaterial' in m && m.isChildMaterial) {
                    return sum + (m.last_purchase_price || 0) * (m.consumption || 1)
                  }
                  return sum
                }, 0).toFixed(2)} ‚ÇΩ
              </span>
            </div>
          </div>
        )
      },
    },
    {
      title: '–ï–¥. –∏–∑–º.',
      dataIndex: 'unit_short_name',
      key: 'unit_short_name',
      width: 80,
      sorter: (a: any, b: any) => a.unit_short_name.localeCompare(b.unit_short_name),
    },
    {
      title: '–†–∞—Å—Ö–æ–¥',
      key: 'consumption',
      width: 100,
      render: (_: any, record: HierarchicalDataItem) => {
        if ('isChildMaterial' in record && record.isChildMaterial && record.consumption) {
          return (
            <span style={{ color: '#1890ff', fontWeight: 500 }}>
              {record.consumption} {record.unit_short_name}
            </span>
          )
        }
        return ('isChildMaterial' in record && record.isChildMaterial) ? '1 –µ–¥.' : '‚Äî'
      },
    },
    {
      title: '–¶–µ–Ω–∞',
      key: 'price',
      width: 120,
      render: (_: any, record: HierarchicalDataItem) => {
        if ('isChildMaterial' in record && record.isChildMaterial) {
          const price = record.last_purchase_price || 0
          const consumption = record.consumption || 1
          const totalCost = price * consumption
          
          return (
            <div>
              <div>{price.toFixed(2)} ‚ÇΩ/{record.unit_short_name}</div>
              {consumption !== 1 && (
                <div style={{ fontSize: '11px', color: '#666' }}>
                  –ò—Ç–æ–≥–æ: {totalCost.toFixed(2)} ‚ÇΩ
                </div>
              )}
            </div>
          )
        }
        
        // –î–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Ä–∞—Å—Ü–µ–Ω–æ–∫ - –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É + —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        const rateMaterials = hierarchicalData.filter(item => 
          'isChildMaterial' in item && item.isChildMaterial && 
          'parentRateId' in item && item.parentRateId === record.id
        )
        const materialsCost = rateMaterials.reduce((sum, m) => {
          if ('isChildMaterial' in m && m.isChildMaterial) {
            return sum + (m.last_purchase_price || 0) * (m.consumption || 1)
          }
          return sum
        }, 0)
        const totalCost = ('base_price' in record ? record.base_price : 0) + materialsCost
        
        return (
          <div>
            <div style={{ fontWeight: 600 }}>
              {totalCost.toFixed(2)} ‚ÇΩ
            </div>
            <div style={{ fontSize: '11px', color: '#666' }}>
              –†–∞–±–æ—Ç–∞: {('base_price' in record ? record.base_price : 0).toFixed(2)} ‚ÇΩ
            </div>
            {materialsCost > 0 && (
              <div style={{ fontSize: '11px', color: '#52c41a' }}>
                –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: {materialsCost.toFixed(2)} ‚ÇΩ
              </div>
            )}
          </div>
        )
      },
      sorter: (a: HierarchicalDataItem, b: HierarchicalDataItem) => {
        let priceA, priceB
        
        if ('isChildMaterial' in a && a.isChildMaterial) {
          priceA = a.last_purchase_price || 0
        } else {
          const aMaterials = hierarchicalData.filter(item => 
            'isChildMaterial' in item && item.isChildMaterial && 
            'parentRateId' in item && item.parentRateId === a.id
          )
          const aMaterialsCost = aMaterials.reduce((sum, m) => {
            if ('isChildMaterial' in m && m.isChildMaterial) {
              return sum + (m.last_purchase_price || 0) * (m.consumption || 1)
            }
            return sum
          }, 0)
          priceA = ('base_price' in a ? a.base_price : 0) + aMaterialsCost
        }
        
        if ('isChildMaterial' in b && b.isChildMaterial) {
          priceB = b.last_purchase_price || 0
        } else {
          const bMaterials = hierarchicalData.filter(item => 
            'isChildMaterial' in item && item.isChildMaterial && 
            'parentRateId' in item && item.parentRateId === b.id
          )
          const bMaterialsCost = bMaterials.reduce((sum, m) => {
            if ('isChildMaterial' in m && m.isChildMaterial) {
              return sum + (m.last_purchase_price || 0) * (m.consumption || 1)
            }
            return sum
          }, 0)
          priceB = ('base_price' in b ? b.base_price : 0) + bMaterialsCost
        }
        
        return priceA - priceB
      },
    },
    {
      title: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
      dataIndex: 'category',
      key: 'category',
      width: 180,
      render: (category: string, record: any) => {
        if (record.isChildMaterial) {
          const materialCategories = {
            concrete: { label: '–ë–µ—Ç–æ–Ω', color: 'blue' },
            metal: { label: '–ú–µ—Ç–∞–ª–ª', color: 'volcano' },
            brick: { label: '–ö–∏—Ä–ø–∏—á', color: 'orange' },
            insulation: { label: '–£—Ç–µ–ø–ª–∏—Ç–µ–ª–∏', color: 'green' },
            finishing: { label: '–û—Ç–¥–µ–ª–æ—á–Ω—ã–µ', color: 'purple' },
            material: { label: '–ú–∞—Ç–µ—Ä–∏–∞–ª', color: 'red' },
            other: { label: '–ü—Ä–æ—á–∏–µ', color: 'default' }
          }
          const config = materialCategories[category as keyof typeof materialCategories] || materialCategories.other
          return <Tag color={config.color}>{config.label}</Tag>
        }
        const config = getCategoryConfig(category)
        return <Tag color={config.color}>{config.label}</Tag>
      },
      sorter: (a: any, b: any) => a.category.localeCompare(b.category),
    },
    {
      title: '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è/–ü–æ—Å—Ç–∞–≤—â–∏–∫',
      key: 'subcategory_supplier',
      render: (_: any, record: any) => {
        if (record.isChildMaterial) {
          return record.supplier || '-'
        }
        return record.subcategory || '-'
      },
    },
    {
      title: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
      dataIndex: 'is_active',
      key: 'is_active',
      width: 100,
      render: (isActive: boolean, record: any) => (
        <span
          style={{
            color: isActive ? '#52c41a' : '#ff4d4f',
            fontWeight: 500,
            opacity: record.isChildMaterial ? 0.7 : 1
          }}
        >
          {isActive ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}
        </span>
      ),
      sorter: (a: any, b: any) => Number(a.is_active) - Number(b.is_active),
    },
    {
      title: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
      dataIndex: 'created_at',
      key: 'created_at',
      width: 140,
      render: (date: string, record: any) => (
        <span style={{ opacity: record.isChildMaterial ? 0.7 : 1 }}>
          {new Date(date).toLocaleDateString('ru-RU')}
        </span>
      ),
      sorter: (a: any, b: any) =>
        new Date(a.created_at).getTime() - new Date(b.created_at).getTime(),
    },
    {
      title: '–î–µ–π—Å—Ç–≤–∏—è',
      key: 'actions',
      width: 180,
      render: (_: unknown, record: any) => {
        if (record.isChildMaterial) {
          return (
            <Space>
              <Button
                type="text"
                size="small"
                icon={<EditOutlined />}
                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª"
                style={{ color: '#1890ff' }}
                onClick={() => handleEditMaterial(record)}
              />
              <Button
                type="text"
                size="small"
                danger
                icon={<DeleteOutlined />}
                title="–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª"
                onClick={() => handleDeleteMaterial(record)}
              />
            </Space>
          )
        }
        
        return (
          <Space>
            <Button
              type="text"
              size="small"
              icon={<PlusOutlined />}
              onClick={() => handleAddMaterial(record)}
              title="–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª"
              style={{ color: '#52c41a' }}
            />
            <Button
              type="text"
              size="small"
              onClick={() => addExampleMaterials(record.id)}
              title="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"
              style={{ color: '#1890ff', fontSize: '10px' }}
            >
              –ü—Ä–∏–º–µ—Ä—ã
            </Button>
            <Button
              type="text"
              size="small"
              icon={<EditOutlined />}
              onClick={() => handleEdit(record)}
              title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É"
            />
            <Popconfirm
              title="–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É?"
              description="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."
              onConfirm={() => handleDelete(record.id)}
              okText="–î–∞"
              cancelText="–û—Ç–º–µ–Ω–∞"
            >
              <Button
                type="text"
                size="small"
                danger
                icon={<DeleteOutlined />}
                title="–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É"
              />
            </Popconfirm>
          </Space>
        )
      },
    },
  ]

  return (
    <div style={{
      height: 'calc(100vh - 96px)',
      display: 'flex',
      flexDirection: 'column',
      overflow: 'hidden'
    }}>
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ */}
      <div className="modern-page-header" style={{ flexShrink: 0, paddingBottom: 16 }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: 16
        }}>
          <div className="modern-page-title">
            <div className="modern-page-icon rates">
              <BuildOutlined />
            </div>
            <div>
              <Title level={2} style={{ margin: 0, color: '#1a1a1a', fontSize: 28, fontWeight: 700 }}>
                –°–±–æ—Ä–Ω–∏–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫
              </Title>
              <div style={{ color: '#64748b', fontSize: 14, marginTop: 4 }}>
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ü–µ–Ω–∫–∞–º–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏
              </div>
            </div>
          </div>
          <Button
            type="primary"
            size="large"
            icon={<PlusOutlined />}
            onClick={handleAddNewGroup}
            style={{
              borderRadius: 8,
              height: 44,
              paddingLeft: 24,
              paddingRight: 24,
              fontSize: 15,
              fontWeight: 600
            }}
          >
            –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É
          </Button>
        </div>

        {/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */}
        <Card style={{ borderRadius: 12, boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
          <Row gutter={[16, 16]}>
            <Col xs={24} sm={12} md={8} lg={6}>
              <div style={{ marginBottom: 4, fontSize: 13, fontWeight: 500, color: '#374151' }}>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
              <Select
                style={{ width: '100%' }}
                placeholder="–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
                allowClear
                showSearch
                value={categoryFilter}
                onChange={handleCategoryFilter}
                filterOption={(input, option) => {
                  const text = (option?.children || option?.label)?.toString() || ""
                  return text.toLowerCase().includes(input.toLowerCase())
                }}
              >
                {categoryOptions.map(opt => (
                  <Select.Option key={opt.value} value={opt.value}>
                    <Tag color={opt.color} style={{ marginRight: 8 }}>{opt.label}</Tag>
                  </Select.Option>
                ))}
              </Select>
            </Col>
            <Col xs={24} sm={12} md={8} lg={6}>
              <div style={{ marginBottom: 4, fontSize: 13, fontWeight: 500, color: '#374151' }}>–ü–æ–∏—Å–∫</div>
              <Search
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..."
                allowClear
                onSearch={handleSearch}
                onChange={(e) => handleSearch(e.target.value)}
                style={{ width: '100%' }}
              />
            </Col>
            <Col xs={24} sm={12} md={8} lg={6}>
              <div style={{ marginBottom: 4, fontSize: 13, fontWeight: 500, color: '#374151' }}>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</div>
              <Select
                style={{ width: '100%' }}
                placeholder="–í—Å–µ –µ–¥–∏–Ω–∏—Ü—ã"
                allowClear
                showSearch
                filterOption={(input, option) => {
                  const text = (option?.children || option?.label)?.toString() || ""
                  return text.toLowerCase().includes(input.toLowerCase())
                }}
              >
                {units.map(unit => (
                  <Select.Option key={unit.id} value={unit.short_name}>
                    {unit.name} ({unit.short_name})
                  </Select.Option>
                ))}
              </Select>
            </Col>
            <Col xs={24} sm={12} md={8} lg={6}>
              <div style={{ marginBottom: 4, fontSize: 13, fontWeight: 500, color: '#374151' }}>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
              <div style={{ display: 'flex', gap: 16 }}>
                <Statistic
                  title="–í—Å–µ–≥–æ"
                  value={filteredGroups.length}
                  suffix="—Ä–∞—Å—Ü–µ–Ω–æ–∫"
                  valueStyle={{ fontSize: 16, color: '#1890ff' }}
                />
                <Statistic
                  title="–û–±—â–∞—è —Å—É–º–º–∞"
                  value={totalCost}
                  formatter={(value) => formatCurrency(Number(value))}
                  valueStyle={{ fontSize: 16, color: '#52c41a' }}
                />
              </div>
            </Col>
          </Row>
        </Card>
      </div>

      {/* –ö–æ–Ω—Ç–µ–Ω—Ç —Å —Ä–∞—Å—Ü–µ–Ω–∫–∞–º–∏ */}
      <div style={{ flex: 1, overflow: 'hidden', minHeight: 0 }}>
        {filteredGroups.length === 0 ? (
          <Card style={{ textAlign: 'center', borderRadius: 12, margin: '20px 0' }}>
            <div style={{ padding: '40px 20px' }}>
              <FileTextOutlined style={{ fontSize: 48, color: '#d9d9d9', marginBottom: 16 }} />
              <Title level={4} style={{ color: '#999', marginBottom: 8 }}>
                {isLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ü–µ–Ω–æ–∫...' : '–†–∞—Å—Ü–µ–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}
              </Title>
              <Text type="secondary">
                {isLoading ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...' : '–ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ä–∞—Å—Ü–µ–Ω–∫–∏'}
              </Text>
              {!isLoading && (
                <div style={{ marginTop: 20 }}>
                  <Button type="primary" icon={<PlusOutlined />} onClick={handleAddNewGroup}>
                    –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Ä–∞—Å—Ü–µ–Ω–∫—É
                  </Button>
                </div>
              )}
            </div>
          </Card>
        ) : (
          <div className="rates-categories-container">
            {/* –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π */}
            {categoryOptions.map(categoryOption => {
              const categoryRates = filteredGroups.filter(group => {
                const rate = rates.find(r => r.id === group.id)
                return rate?.category === categoryOption.value
              })

              const isExpanded = expandedCategories.has(categoryOption.value)
              const hasRates = categoryRates.length > 0

              return (
                <div key={categoryOption.value} className="category-section" style={{ marginBottom: 24 }}>
                  {/* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */}
                  <div
                    style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      padding: '16px 20px',
                      background: hasRates
                        ? `linear-gradient(135deg, ${categoryOption.color}15, ${categoryOption.color}08)`
                        : '#f8f9fa',
                      borderRadius: 12,
                      border: hasRates
                        ? `1px solid ${categoryOption.color}30`
                        : '1px solid #e9ecef',
                      cursor: hasRates ? 'pointer' : 'default',
                      transition: 'all 0.2s ease',
                      opacity: hasRates ? 1 : 0.6
                    }}
                    onClick={() => hasRates && toggleCategoryExpansion(categoryOption.value)}
                    onMouseEnter={(e) => {
                      if (hasRates) {
                        e.currentTarget.style.background = `linear-gradient(135deg, ${categoryOption.color}25, ${categoryOption.color}15)`
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (hasRates) {
                        e.currentTarget.style.background = `linear-gradient(135deg, ${categoryOption.color}15, ${categoryOption.color}08)`
                      }
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                      {hasRates && (
                        <div style={{
                          width: 20,
                          height: 20,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: categoryOption.color
                        }}>
                          {isExpanded ? <DownOutlined /> : <RightOutlined />}
                        </div>
                      )}
                      <Tag color={categoryOption.color} style={{
                        margin: 0,
                        fontSize: 13,
                        fontWeight: 600,
                        padding: '4px 12px',
                        borderRadius: 8
                      }}>
                        {categoryOption.label}
                      </Tag>
                      <Text style={{ fontSize: 14, color: hasRates ? '#64748b' : '#999' }}>
                        {hasRates
                          ? `${categoryRates.length} —Ä–∞—Å—Ü–µ–Ω–æ–∫ ‚Ä¢ ${formatCurrency(categoryRates.reduce((sum, group) => sum + group.totalSum, 0))}`
                          : '–ù–µ—Ç —Ä–∞—Å—Ü–µ–Ω–æ–∫'
                        }
                      </Text>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                      {hasRates && isExpanded && (
                        <Button
                          type="primary"
                          size="small"
                          icon={<PlusOutlined />}
                          onClick={(e) => {
                            e.stopPropagation()
                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ä–∞—Å—Ü–µ–Ω–∫—É —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
                            setEditingRate(null)
                            form.resetFields()
                            form.setFieldsValue({
                              is_active: true,
                              category: categoryOption.value,
                              base_price: 0,
                            })
                            setTempRateMaterials([])
                            setActiveTab('1')
                            setIsModalOpen(true)
                          }}
                          style={{ borderRadius: 6 }}
                        >
                          –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É
                        </Button>
                      )}
                      {!hasRates && (
                        <Button
                          type="dashed"
                          size="small"
                          icon={<PlusOutlined />}
                          onClick={(e) => {
                            e.stopPropagation()
                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ä–∞—Å—Ü–µ–Ω–∫—É —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
                            setEditingRate(null)
                            form.resetFields()
                            form.setFieldsValue({
                              is_active: true,
                              category: categoryOption.value,
                              base_price: 0,
                            })
                            setTempRateMaterials([])
                            setActiveTab('1')
                            setIsModalOpen(true)
                          }}
                          style={{ borderRadius: 6 }}
                        >
                          –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Ä–∞—Å—Ü–µ–Ω–∫—É
                        </Button>
                      )}
                    </div>
                  </div>

                  {/* –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ü–µ–Ω–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞) */}
                  {isExpanded && hasRates && (
                    <Card style={{ borderRadius: 12, overflow: 'hidden', border: `1px solid ${categoryOption.color}20`, marginTop: 16 }}>
                    <div className="modern-table" style={{ overflow: 'hidden' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead>
                          <tr style={{
                            background: `linear-gradient(135deg, ${categoryOption.color}, ${categoryOption.color}dd)`,
                            color: 'white'
                          }}>
                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: 600, fontSize: 13, border: 'none' }}>–ö–æ–¥</th>
                            <th style={{ padding: '12px 16px', textAlign: 'left', fontWeight: 600, fontSize: 13, border: 'none' }}>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                            <th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: 600, fontSize: 13, border: 'none' }}>–ï–¥. –∏–∑–º.</th>
                            <th style={{ padding: '12px 16px', textAlign: 'right', fontWeight: 600, fontSize: 13, border: 'none' }}>–¶–µ–Ω–∞ —Ä–∞–±–æ—Ç</th>
                            <th style={{ padding: '12px 16px', textAlign: 'right', fontWeight: 600, fontSize: 13, border: 'none' }}>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th>
                            <th style={{ padding: '12px 16px', textAlign: 'right', fontWeight: 600, fontSize: 13, border: 'none' }}>–ò—Ç–æ–≥–æ</th>
                            <th style={{ padding: '12px 16px', textAlign: 'center', fontWeight: 600, fontSize: 13, border: 'none', width: 120 }}>–î–µ–π—Å—Ç–≤–∏—è</th>
                          </tr>
                        </thead>
                        <tbody>
                          {categoryRates.map((group, index) => {
                            const rate = rates.find(r => r.id === group.id)
                            const isExpanded = expandedRates.has(group.id)
                            const worksCost = group.works.reduce((sum, w) => sum + w.total, 0)
                            const materialsCost = group.materials.reduce((sum, m) => sum + m.total, 0)

                            return (
                              <React.Fragment key={group.id}>
                                <tr
                                  style={{
                                    backgroundColor: index % 2 === 0 ? '#fafafa' : 'white',
                                    borderBottom: '1px solid #f0f0f0',
                                    cursor: 'pointer',
                                    transition: 'background-color 0.2s ease'
                                  }}
                                  onMouseEnter={(e) => {
                                    e.currentTarget.style.backgroundColor = `${categoryOption.color}10`
                                  }}
                                  onMouseLeave={(e) => {
                                    e.currentTarget.style.backgroundColor = index % 2 === 0 ? '#fafafa' : 'white'
                                  }}
                                  onClick={() => toggleRateExpansion(group.id)}
                                >
                                  <td style={{ padding: '12px 16px', fontSize: 13, fontWeight: 600, color: '#1890ff' }}>
                                    {rate?.code || '-'}
                                  </td>
                                  <td style={{ padding: '12px 16px' }}>
                                    <div>
                                      <div style={{ fontSize: 14, fontWeight: 600, color: '#1a1a1a', marginBottom: 2 }}>
                                        {group.contractor.name}
                                      </div>
                                      {rate?.description && (
                                        <div style={{ fontSize: 12, color: '#64748b', lineHeight: 1.3 }}>
                                          {rate.description.length > 80
                                            ? `${rate.description.substring(0, 80)}...`
                                            : rate.description
                                          }
                                        </div>
                                      )}
                                      {group.materials.length > 0 && (
                                        <div style={{ fontSize: 11, color: '#52c41a', marginTop: 4 }}>
                                          üì¶ {group.materials.length} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                                        </div>
                                      )}
                                    </div>
                                  </td>
                                  <td style={{ padding: '12px 16px', textAlign: 'center', fontSize: 13 }}>
                                    {group.contractor.unit}
                                  </td>
                                  <td style={{ padding: '12px 16px', textAlign: 'right', fontSize: 14, fontWeight: 600, color: '#1890ff' }}>
                                    {formatCurrency(worksCost)}
                                  </td>
                                  <td style={{ padding: '12px 16px', textAlign: 'right', fontSize: 14, fontWeight: 600, color: '#52c41a' }}>
                                    {formatCurrency(materialsCost)}
                                  </td>
                                  <td style={{ padding: '12px 16px', textAlign: 'right', fontSize: 16, fontWeight: 700, color: '#1a1a1a' }}>
                                    {formatCurrency(group.totalSum)}
                                  </td>
                                  <td style={{ padding: '12px 16px', textAlign: 'center' }} onClick={(e) => e.stopPropagation()}>
                                    <Space>
                                      <Button
                                        type="text"
                                        size="small"
                                        icon={<EditOutlined />}
                                        onClick={(e) => {
                                          e.stopPropagation()
                                          handleEditGroup(group.id)
                                        }}
                                        style={{ color: '#1890ff' }}
                                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                                      />
                                      <Popconfirm
                                        title="–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫—É?"
                                        description="–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å"
                                        onConfirm={(e) => {
                                          e?.stopPropagation()
                                          handleDeleteGroup(group.id)
                                        }}
                                        okText="–î–∞"
                                        cancelText="–û—Ç–º–µ–Ω–∞"
                                        onClick={(e) => e?.stopPropagation()}
                                      >
                                        <Button
                                          type="text"
                                          size="small"
                                          danger
                                          icon={<DeleteOutlined />}
                                          onClick={(e) => e.stopPropagation()}
                                          title="–£–¥–∞–ª–∏—Ç—å"
                                        />
                                      </Popconfirm>
                                    </Space>
                                  </td>
                                </tr>

                                {/* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö */}
                                {isExpanded && group.materials.length > 0 && (
                                  <tr style={{ backgroundColor: `${categoryOption.color}05` }}>
                                    <td colSpan={7} style={{ padding: '16px', border: 'none' }}>
                                      <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                                        gap: 12
                                      }}>
                                        {group.materials.map((material, matIndex) => (
                                          <div key={matIndex} style={{
                                            padding: '12px',
                                            backgroundColor: 'white',
                                            borderRadius: 8,
                                            border: '1px solid #e9ecef',
                                            boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                                          }}>
                                            <div style={{
                                              display: 'flex',
                                              justifyContent: 'space-between',
                                              alignItems: 'flex-start',
                                              marginBottom: 8
                                            }}>
                                              <div style={{ flex: 1 }}>
                                                <div style={{ fontSize: 13, fontWeight: 600, color: '#1a1a1a', marginBottom: 2 }}>
                                                  {material.name}
                                                </div>
                                                <div style={{ fontSize: 11, color: '#64748b' }}>
                                                  {material.materialType && `${material.materialType} ‚Ä¢ `}
                                                  {material.volume} {material.unit} √ó {material.consumptionRate}
                                                </div>
                                              </div>
                                              <div style={{ textAlign: 'right' }}>
                                                <div style={{ fontSize: 13, fontWeight: 600, color: '#52c41a' }}>
                                                  {formatCurrency(material.total)}
                                                </div>
                                                <div style={{ fontSize: 11, color: '#64748b' }}>
                                                  {formatCurrency(material.materialPrice)}/{material.unit}
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    </td>
                                  </tr>
                                )}
                              </React.Fragment>
                            )
                          })}
                        </tbody>
                      </table>
                    </div>
                    </Card>
                  )}
                </div>
              )
            })}
          </div>
        )}
      </div>


      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */}
      <AddRateModal
        visible={isAddModalVisible}
        onCancel={() => setIsAddModalVisible(false)}
        onSave={handleSaveNewGroup}
      />

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Ü–µ–Ω–∫–∏ */}
      <Modal
        title={editingRate ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏' : '–ù–æ–≤–∞—è —Ä–∞—Å—Ü–µ–Ω–∫–∞'}
        open={isModalOpen}
        onCancel={handleCloseModal}
        width={1000}
        footer={[
          <Button key="cancel" onClick={handleCloseModal}>
            –û—Ç–º–µ–Ω–∞
          </Button>,
          <Button
            key="submit"
            type="primary"
            loading={createMutation.isPending || updateMutation.isPending}
            onClick={handleSubmit}
          >
            {editingRate ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
          </Button>,
        ]}
      >
        <Tabs activeKey={activeTab} onChange={setActiveTab}>
          <Tabs.TabPane tab="–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" key="1">
            <Form form={form} layout="vertical">
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item
                    label="–ö–æ–¥"
                    name="code"
                    rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ä–∞—Å—Ü–µ–Ω–∫–∏' }]}
                  >
                    <Input placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–ê–ë-001" />
                  </Form.Item>
                </Col>
                <Col span={16}>
                  <Form.Item
                    label="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
                    name="name"
                    rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' }]}
                  >
                    <Input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏" />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={24}>
                  <Form.Item label="–û–ø–∏—Å–∞–Ω–∏–µ" name="description">
                    <Input.TextArea rows={3} placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç" />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item
                    label="–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"
                    name="unit_id"
                    rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É' }]}
                  >
                    <Select
                      placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É"
                      showSearch
                      filterOption={(input, option) =>
                        (option?.children || '')
                          .toString()
                          .toLowerCase()
                          .includes(input.toLowerCase())
                      }
                    >
                      {units.map(unit => (
                        <Select.Option key={unit.id} value={unit.id}>
                          {unit.name} ({unit.short_name})
                        </Select.Option>
                      ))}
                    </Select>
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item
                    label="–ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å"
                    name="base_price"
                    rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å' }]}
                  >
                    <InputNumber
                      min={0}
                      step={0.01}
                      style={{ width: '100%' }}
                      placeholder="0.00"
                      addonAfter="‚ÇΩ"
                    />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item
                    label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è"
                    name="category"
                    rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é' }]}
                  >
                    <Select
                      placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
                      onChange={(newCategory) => {
                        // –†–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞—Å—Ü–µ–Ω–æ–∫)
                        if (!editingRate) {
                          const existingCodes = rates.map(r => r.code)
                          const generatedCode = generateRateCode(newCategory, existingCodes)
                          form.setFieldsValue({ code: generatedCode })

                          console.log('Category changed, code regenerated:', {
                            action: 'category_change_code_regenerate',
                            newCategory,
                            generatedCode,
                            timestamp: new Date().toISOString(),
                          })
                        }
                      }}
                    >
                      {categoryOptions.map(cat => (
                        <Select.Option key={cat.value} value={cat.value}>
                          <Tag color={cat.color}>{cat.label}</Tag>
                        </Select.Option>
                      ))}
                    </Select>
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item label="–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è" name="subcategory">
                    <Input placeholder="–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item label="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" name="is_active" valuePropName="checked">
                    <Switch checkedChildren="–ê–∫—Ç–∏–≤–Ω–∞" unCheckedChildren="–ù–µ–∞–∫—Ç–∏–≤–Ω–∞" />
                  </Form.Item>
                </Col>
              </Row>
            </Form>
          </Tabs.TabPane>

          <Tabs.TabPane tab={`–ú–∞—Ç–µ—Ä–∏–∞–ª—ã (${tempRateMaterials.length})`} key="2">
            <div style={{ marginBottom: 16 }}>
              <Button
                type="dashed"
                onClick={addTempMaterial}
                icon={<PlusOutlined />}
                style={{ width: '100%' }}
              >
                –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
              </Button>
            </div>

            <div style={{ marginBottom: 16 }}>
              <Select
                showSearch
                allowClear
                style={{ width: '100%' }}
                placeholder={materialsLoading ? "–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤..." : "–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞"}
                optionFilterProp="children"
                onChange={addMaterialFromCatalog}
                value={selectedCatalogMaterial}
                disabled={materialsLoading || materials.length === 0}
                filterOption={(input, option) =>
                  (option?.children || '')
                    .toString()
                    .toLowerCase()
                    .includes(input.toLowerCase())
                }
                notFoundContent={materialsLoading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : materials.length === 0 ? "–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ" : "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"}
              >
                {materials.map(material => (
                  <Select.Option key={material.id} value={material.id}>
                    {material.code} - {material.name} ({material.unit_short_name})
                  </Select.Option>
                ))}
              </Select>
            </div>

            <div style={{ maxHeight: 400, overflowY: 'auto' }}>
              {tempRateMaterials.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 20, color: '#999' }}>
                  –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
                </div>
              ) : (
                tempRateMaterials.map((material, index) => (
                  <Card key={material.id} size="small" style={{ marginBottom: 8 }}>
                    <Row gutter={16}>
                      <Col span={6}>
                        <Input
                          placeholder="–ö–æ–¥"
                          value={material.code}
                          onChange={e => updateTempMaterial(material.id, 'code', e.target.value)}
                        />
                      </Col>
                      <Col span={10}>
                        <Input
                          placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
                          value={material.name}
                          onChange={e => updateTempMaterial(material.id, 'name', e.target.value)}
                        />
                      </Col>
                      <Col span={3}>
                        <InputNumber
                          placeholder="–†–∞—Å—Ö–æ–¥"
                          value={material.consumption}
                          onChange={value => updateTempMaterial(material.id, 'consumption', value)}
                          min={0}
                          step={0.01}
                          style={{ width: '100%' }}
                        />
                      </Col>
                      <Col span={3}>
                        <InputNumber
                          placeholder="–¶–µ–Ω–∞"
                          value={material.last_purchase_price}
                          onChange={value => updateTempMaterial(material.id, 'last_purchase_price', value)}
                          min={0}
                          step={0.01}
                          style={{ width: '100%' }}
                        />
                      </Col>
                      <Col span={2}>
                        <Button
                          type="text"
                          danger
                          icon={<DeleteOutlined />}
                          onClick={() => removeTempMaterial(material.id)}
                        />
                      </Col>
                    </Row>
                  </Card>
                ))
              )}
            </div>
          </Tabs.TabPane>
        </Tabs>
      </Modal>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ */}
      <Modal
        title="–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞"
        open={isMaterialModalOpen}
        onCancel={handleCloseMaterialModal}
        footer={[
          <Button key="cancel" onClick={handleCloseMaterialModal}>
            –û—Ç–º–µ–Ω–∞
          </Button>,
          <Button
            key="submit"
            type="primary"
            loading={createMaterialMutation.isPending}
            onClick={handleMaterialSubmit}
          >
            –î–æ–±–∞–≤–∏—Ç—å
          </Button>,
        ]}
      >
        <Form form={materialForm} layout="vertical">
          <Row gutter={16}>
            <Col span={8}>
              <Form.Item
                label="–ö–æ–¥"
                name="code"
                rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥' }]}
              >
                <Input placeholder="–ú–ê–¢-001" />
              </Form.Item>
            </Col>
            <Col span={16}>
              <Form.Item
                label="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"
                name="name"
                rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' }]}
              >
                <Input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞" />
              </Form.Item>
            </Col>
          </Row>
          <Row gutter={16}>
            <Col span={24}>
              <Form.Item label="–û–ø–∏—Å–∞–Ω–∏–µ" name="description">
                <Input.TextArea rows={2} placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞" />
              </Form.Item>
            </Col>
          </Row>
          <Row gutter={16}>
            <Col span={8}>
              <Form.Item
                label="–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è"
                name="unit_id"
                rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É' }]}
              >
                <Select
                  placeholder="–í—ã–±–µ—Ä–∏—Ç–µ"
                  showSearch
                  filterOption={(input, option) =>
                    (option?.children || '')
                      .toString()
                      .toLowerCase()
                      .includes(input.toLowerCase())
                  }
                >
                  {units.map(unit => (
                    <Select.Option key={unit.id} value={unit.id}>
                      {unit.name} ({unit.short_name})
                    </Select.Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item label="–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏" name="last_purchase_price">
                <InputNumber
                  min={0}
                  step={0.01}
                  style={{ width: '100%' }}
                  placeholder="0.00"
                  addonAfter="‚ÇΩ"
                />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" name="category">
                <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ">
                  <Select.Option value="material">–ú–∞—Ç–µ—Ä–∏–∞–ª</Select.Option>
                  <Select.Option value="concrete">–ë–µ—Ç–æ–Ω</Select.Option>
                  <Select.Option value="metal">–ú–µ—Ç–∞–ª–ª</Select.Option>
                  <Select.Option value="brick">–ö–∏—Ä–ø–∏—á</Select.Option>
                </Select>
              </Form.Item>
            </Col>
          </Row>
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item label="–ü–æ—Å—Ç–∞–≤—â–∏–∫" name="supplier">
                <Input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" />
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item label="–ê—Ä—Ç–∏–∫—É–ª –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" name="supplier_article">
                <Input placeholder="–ê—Ä—Ç–∏–∫—É–ª" />
              </Form.Item>
            </Col>
          </Row>
          <Form.Item label="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" name="is_active" valuePropName="checked">
            <Switch checkedChildren="–ê–∫—Ç–∏–≤–µ–Ω" unCheckedChildren="–ù–µ–∞–∫—Ç–∏–≤–µ–Ω" />
          </Form.Item>
        </Form>
      </Modal>

    </div>
  )
}

export default Rates

