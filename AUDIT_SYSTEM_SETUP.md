# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞ –ø–æ—Ä—Ç–∞–ª–∞ STAR

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞ –ø–æ—Ä—Ç–∞–ª–∞ STAR –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π, –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º, –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –≤ –ë–î

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –ª–æ–≥–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
psql "$DATABASE_URL" -f create_audit_log.sql
```

–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:

```sql
-- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ create_audit_log.sql
-- –≤ –≤–∞—à–µ–º PostgreSQL –∫–ª–∏–µ–Ω—Ç–µ (pgAdmin, DBeaver, –∏–ª–∏ psql)
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞
SELECT COUNT(*) FROM portal_audit_log;

-- –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
SELECT
    schemaname,
    tablename,
    triggername
FROM pg_trigger t
JOIN pg_class c ON c.oid = t.tgrelid
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE triggername LIKE 'audit_trigger%';
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î** (—Ç—Ä–∏–≥–≥–µ—Ä—ã)
   - CREATE, UPDATE, DELETE –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ

2. **–†—É—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (React —Ö—É–∫–∏)
   - –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –∫–ª–∏–∫–∏, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –ø–æ–∏—Å–∫
   - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: —ç–∫—Å–ø–æ—Ä—Ç, –∏–º–ø–æ—Ä—Ç, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π

- `create` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
- `update` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
- `delete` - –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `view` - –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- `export` - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
- `import` - –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
- `navigate` - –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
- `login` - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (–±—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- `logout` - –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (–±—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

### –í React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```typescript
import { usePortalLogger } from '@/shared/hooks/usePortalLogger'

function MyComponent() {
  const logger = usePortalLogger()

  const handleEdit = (itemId: string, newData: any) => {
    // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    updateItem(itemId, newData)

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
    logger.logUpdate('items', itemId, oldData, newData, '–û–±–Ω–æ–≤–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç')
  }

  const handleButtonClick = () => {
    logger.logButtonClick('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö', '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞')
  }

  return <button onClick={handleButtonClick}>–≠–∫—Å–ø–æ—Ä—Ç</button>
}
```

### –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

```typescript
import { auditLogApi } from '@/shared/api/audit-log-api'

// –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –ª–æ–≥–∞
await auditLogApi.create({
  action_type: 'create',
  table_name: 'products',
  record_id: '123',
  new_values: { name: '–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç' },
  changes_summary: '–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç',
})

// –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
const logs = await auditLogApi.getAll({
  action_type: 'update',
  date_from: '2024-01-01',
  limit: 100,
})
```

## –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

–ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `/developer/audit-logs` –≤ —Ä–∞–∑–¥–µ–ª–µ "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫".

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏–π, —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º
- üîç **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** - –ø–æ –¥–∞—Ç–µ, —Ç–∏–ø—É –¥–µ–π—Å—Ç–≤–∏—è, —Ç–∞–±–ª–∏—Ü–µ
- üìã **–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - ID –∑–∞–ø–∏—Å–∏, —Å–µ—Å—Å–∏—è, —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –æ–ø–∏—Å–∞–Ω–∏–µ
- üîÑ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- üì§ **–≠–∫—Å–ø–æ—Ä—Ç** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

1. **–ò–Ω–¥–µ–∫—Å—ã –ë–î** - —Å–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ–ª—è–º –ø–æ–∏—Å–∫–∞
2. **–õ–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - —Å–±–æ–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
-- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –ª–æ–≥–æ–≤
SELECT
  schemaname,
  tablename,
  attname,
  n_distinct,
  correlation
FROM pg_stats
WHERE tablename = 'portal_audit_log';

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–æ –¥–Ω—è–º
SELECT
  DATE(created_at) as date,
  COUNT(*) as records_count
FROM portal_audit_log
GROUP BY DATE(created_at)
ORDER BY date DESC
LIMIT 30;
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- üîí **–¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ** - –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –ª–æ–≥–∏
- üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üîê **–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è** - IP –∞–¥—Ä–µ—Å–∞ –∏ User-Agent –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç—ã
- ‚ö†Ô∏è **–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –ø–∞—Ä–æ–ª–∏ –∏ —Ç–æ–∫–µ–Ω—ã –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

## –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

```sql
-- –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 3 –º–µ—Å—è—Ü–µ–≤
DELETE FROM portal_audit_log
WHERE created_at < NOW() - INTERVAL '3 months';

-- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
CREATE TABLE portal_audit_log_archive AS
SELECT * FROM portal_audit_log
WHERE created_at < NOW() - INTERVAL '1 month';
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã –ª–æ–≥–æ–≤
pg_dump "$DATABASE_URL" --table=portal_audit_log --data-only > audit_backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
psql "$DATABASE_URL" < audit_backup.sql
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–≥–∏ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã
SELECT * FROM information_schema.triggers
WHERE trigger_name LIKE 'audit_trigger%';

-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
DROP TRIGGER IF EXISTS audit_trigger_rates ON public.rates;
CREATE TRIGGER audit_trigger_rates
    AFTER INSERT OR UPDATE OR DELETE ON public.rates
    FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_function();
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏ –∏–ª–∏ JavaScript. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫, –ø–æ—ç—Ç–æ–º—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ—è—Ö –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–æ–≥–æ–≤

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT indexname, indexdef FROM pg_indexes
WHERE tablename = 'portal_audit_log';

-- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
EXPLAIN ANALYZE SELECT * FROM portal_audit_log
WHERE action_type = 'update'
AND created_at > NOW() - INTERVAL '1 day'
ORDER BY created_at DESC
LIMIT 100;
```

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

- üîÑ **Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - WebSocket –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –¥–∞—à–±–æ—Ä–¥ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- üîê **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π** - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- üì± **–ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è** - –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
- ü§ñ **AI –∞–Ω–∞–ª–∏–∑** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
