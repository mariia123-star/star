# Диагностика и решение проблем с таблицей tender_estimates

## Проблема

В SQL запросах используются поля `record_type`, `material_type`, `coefficient`, `work_price`, `material_price`, `delivery_cost`, которые отсутствуют в базе данных, что приводит к ошибкам.

## Анализ ситуации

1. **В коде** (файлы TypeScript) используются расширенные поля для тендерной сметы
2. **В базе данных** (файл `prod.sql`) эти поля отсутствуют
3. **Существует миграция** (`tender_estimates_migration.sql`) для добавления этих полей
4. **Миграция не была применена** к продакшн базе данных

## Методы диагностики

### 1. Через веб-интерфейс приложения

1. Откройте http://localhost:5175
2. Перейдите на страницу `/developer/database-debug`
3. Нажмите "Запустить диагностику"
4. Изучите результаты анализа

### 2. Через SQL Editor в Supabase

Выполните файл `ДИАГНОСТИКА_TENDER_ESTIMATES.sql` в SQL Editor вашего Supabase проекта.

### 3. Через консоль браузера

Скопируйте код из файла `debug-db.js` в консоль разработчика браузера на странице приложения.

## Решение проблемы

### Вариант 1: Применить миграцию (Рекомендуется)

```sql
-- Выполните содержимое файла tender_estimates_migration.sql
-- в SQL Editor вашего Supabase проекта
```

### Вариант 2: Обновить prod.sql

1. Замените содержимое `supabase/prod.sql` новой схемой с учетом миграции
2. Пересоздайте базу данных

### Вариант 3: Откатить код к базовой структуре

1. Удалите использование новых полей из TypeScript кода
2. Используйте только базовые поля таблицы tender_estimates

## Ожидаемые результаты после решения

### Успешная диагностика должна показать:

- ✅ Общее количество записей: > 0
- ✅ Группировка по record_type: work, material, summary
- ✅ Структура таблицы содержит 7 новых полей:
  - `material_type`
  - `coefficient`
  - `work_price`
  - `material_price`
  - `delivery_cost`
  - `record_type`
  - `project_id`

### Если проблема не решена:

- ❌ Ошибки при выполнении SQL запросов с новыми полями
- ❌ Поля record_type и другие отсутствуют в схеме
- ❌ Группировка по record_type показывает только NULL значения

## Рекомендуемый план действий

1. **Диагностика**
   - Выполните диагностический SQL или используйте веб-интерфейс
   - Определите текущее состояние базы данных

2. **Применение миграции**
   - Если поля отсутствуют, выполните `tender_estimates_migration.sql`
   - Проверьте результат повторной диагностикой

3. **Проверка функциональности**
   - Откройте страницу "Тендерная смета"
   - Попробуйте создать новую запись
   - Проверьте импорт данных

4. **Обновление prod.sql**
   - После успешного применения миграции
   - Обновите файл prod.sql для синхронизации с текущим состоянием БД

## Контактная информация

При возникновении проблем обратитесь к команде разработки с результатами диагностики.
