# üìÅ –°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞ STAR

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è SQL —Å—Ö–µ–º–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º –ø–æ—Ä—Ç–∞–ª–µ.

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**

#### 1. **`files`** - –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

- üìÑ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ**: –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, MIME-—Ç–∏–ø, —Ä–∞–∑–º–µ—Ä
- üóÇÔ∏è **–•—Ä–∞–Ω–µ–Ω–∏–µ**: —Ç–∏–ø —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (local, supabase, s3, azure), –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞ (public, internal, private, restricted)
- üìä **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**: JSONB –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è EXIF, —Å–≤–æ–π—Å—Ç–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- üìà **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–π —Ñ–∞–π–ª–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ç—Ä–∏–≥–≥–µ—Ä–æ–º
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: —Å—á–µ—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∑–∏–≤—à–µ–º

#### 2. **`file_categories`** - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ñ–∞–π–ª–æ–≤

- üìÇ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ —Ç–∏–ø–∞–º (–î–æ–∫—É–º–µ–Ω—Ç—ã, –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, PDF, –ê—Ä—Ö–∏–≤—ã)
- üé® –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∏–∫–æ–Ω–∫–∏ –∏ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

#### 3. **`file_tags`** - –°–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

- üè∑Ô∏è –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç–æ–∫ –¥–ª—è —Ñ–∞–π–ª–æ–≤
- üìä –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–≥–æ–≤
- üé® –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–≥–æ–≤

#### 4. **`file_versions`** - –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π —Ñ–∞–π–ª–æ–≤

- üìö –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π —Ñ–∞–π–ª–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞

#### 5. **`file_access_logs`** - –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –∞—É–¥–∏—Ç

- üëÅÔ∏è –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π (–ø—Ä–æ—Å–º–æ—Ç—Ä, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, –∑–∞–≥—Ä—É–∑–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ)
- üåê –ó–∞–ø–∏—Å—å IP –∞–¥—Ä–µ—Å–æ–≤, User-Agent, –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç—É–ø–∞
- üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

### **–°–≤—è–∑—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã:**

- **`file_tags_mapping`** - —Å–≤—è–∑—å —Ñ–∞–π–ª–æ–≤ —Å —Ç–µ–≥–∞–º–∏ (many-to-many)

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### **‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**

1. **üìÅ –ú—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ**
   - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
   - Supabase Storage
   - Amazon S3
   - Azure Blob Storage

2. **üîê –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**
   - 4 —É—Ä–æ–≤–Ω—è –¥–æ—Å—Ç—É–ø–∞ (public, internal, private, restricted)
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –ø—Ä–æ–µ–∫—Ç–∞–º
   - –ê—É–¥–∏—Ç –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

3. **üìä –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
   - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
   - –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–µ—Ä—Å–∏—è–º

4. **üè∑Ô∏è –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫**
   - –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
   - –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤
   - –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é

5. **üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
   - –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ —Å IP –∏ –≤—Ä–µ–º–µ–Ω–µ–º
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ —Ç–µ–≥–∏

6. **üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
   - SHA-256 —Ö–µ—à–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
   - Soft delete –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### **1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î:**

```bash
# –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞
psql "$DATABASE_URL" -f supabase/file_storage_schema.sql

# –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
psql "$DATABASE_URL" -f supabase/file_storage_sample_data.sql
```

### **2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views):**

#### **`v_files_with_details`** - –§–∞–π–ª—ã —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

- –§–∞–π–ª—ã + –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + —Ç–µ–≥–∏ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–µ—Ä—Å–∏–π + –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø

#### **`v_file_statistics`** - –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤, —Ä–∞–∑–º–µ—Ä, —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

#### **`v_popular_files`** - –¢–æ–ø —Ñ–∞–π–ª–æ–≤ –ø–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è–º

- –†–µ–π—Ç–∏–Ω–≥ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏

### **3. –ü–æ–ª–µ–∑–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã:**

```sql
-- –í—Å–µ —Ñ–∞–π–ª—ã —Å –¥–µ—Ç–∞–ª—è–º–∏
SELECT * FROM v_files_with_details ORDER BY created_at DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Ä—Ç–∞–ª–∞
SELECT * FROM v_file_statistics;

-- –§–∞–π–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
SELECT
    fc.name as category,
    COUNT(*) as files_count,
    SUM(f.file_size) as total_size
FROM files f
JOIN file_categories fc ON f.category_id = fc.id
WHERE f.is_active = true
GROUP BY fc.name
ORDER BY files_count DESC;

-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏
SELECT name, usage_count, color
FROM file_tags
ORDER BY usage_count DESC;

-- –ò—Å—Ç–æ—Ä–∏—è –¥–æ—Å—Ç—É–ø–∞
SELECT
    f.display_name,
    fal.action,
    fal.ip_address,
    fal.created_at
FROM file_access_logs fal
JOIN files f ON fal.file_id = f.id
ORDER BY fal.created_at DESC
LIMIT 20;
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

–í —Ñ–∞–π–ª–µ `file_storage_sample_data.sql` –≤–∫–ª—é—á–µ–Ω—ã:

- **10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ñ–∞–π–ª–æ–≤** (–î–æ–∫—É–º–µ–Ω—Ç—ã, –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, PDF, –ê—Ä—Ö–∏–≤—ã, –∏ –¥—Ä.)
- **15 —Ç–µ–≥–æ–≤** (–≤–∞–∂–Ω–æ, –ø—Ä–æ–µ–∫—Ç-–∞–ª—å—Ñ–∞, –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ, –∏ –¥—Ä.)
- **6 –ø—Ä–∏–º–µ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤** —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤
- **–õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞** –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- **–í–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤** –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üîß –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### **–¢—Ä–∏–≥–≥–µ—Ä—ã:**

- ‚úÖ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** `updated_at` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π
- ‚úÖ **–ê–≤—Ç–æ–ø–æ–¥—Å—á–µ—Ç** —Å–∫–∞—á–∏–≤–∞–Ω–∏–π –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ **–ê–≤—Ç–æ–ø–æ–¥—Å—á–µ—Ç** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–≥–æ–≤
- ‚úÖ **–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ** –≤–µ—Ä—Å–∏–π —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

### **–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

- üöÄ –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üîç –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é (—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫)
- üìä –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ø–æ—Ä—Ç–∞–ª–µ STAR

–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏–¥–µ–∞–ª—å–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ—Ä—Ç–∞–ª–æ–º STAR –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è:

- üìã **–¢–µ–Ω–¥–µ—Ä–Ω–∞—è —Å–º–µ—Ç–∞**: –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å–º–µ—Ç, —Ä–∞—Å—á–µ—Ç–æ–≤
- üìñ **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- üè¢ **–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã**: –¥–æ–≥–æ–≤–æ—Ä—ã, –æ—Ç—á–µ—Ç—ã, –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
- üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–∞–º

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ
